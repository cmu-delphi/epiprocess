<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Compactify to remove redundant archive data • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Compactify to remove redundant archive data">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.11.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epiprocess.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/epi_df.html">Working with epi_df objects and time series data</a></li>
    <li><a class="dropdown-item" href="../articles/epi_archive.html">Working with epi_archive objects and data revisions</a></li>
    <li><a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a></li>
    <li><a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a></li>
    <li><a class="dropdown-item" href="../articles/correlation.html">Correlate signals across locations and time</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Compactify to remove redundant archive data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/vignettes/compactify.Rmd" class="external-link"><code>vignettes/compactify.Rmd</code></a></small>
      <div class="d-none name"><code>compactify.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="removing-redundant-update-data-to-save-space">Removing redundant update data to save space<a class="anchor" aria-label="anchor" href="#removing-redundant-update-data-to-save-space"></a>
</h2>
<p>We do not need to store version update rows that look like the last
version of the corresponding observations carried forward (LOCF) for use
with <code>epiprocess</code>‘s’ <code>epi_archive</code>-related
functions, as they all apply LOCF to fill in data between explicit
updates. By default, we even detect and remove these LOCF-redundant rows
to save space; this should not impact results as long as you do not
directly work with the archive’s <code>DT</code> field in a way that
expects these rows to remain.</p>
<p>There are three different values that can be assigned to
<code>compactify</code>:</p>
<ul>
<li>
<code>TRUE</code> (default): removes any LOCF-redundant rows without
any message or other feedback</li>
<li>
<code>FALSE</code>: keeps any LOCF-redundant rows without any
message or other feedback</li>
<li>
<code>"message"</code>: if there are LOCF-redundant rows, removes
them and produces a message with some information about what rows were
removed</li>
</ul>
<p>For this example, we have one chart using LOCF values, while another
doesn’t use them to illustrate LOCF. Notice how the head of the first
dataset differs from the second from the third value included.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="va">archive_cases_dv_subset</span><span class="op">$</span><span class="va">DT</span></span>
<span></span>
<span><span class="va">locf_omitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="va">locf_included</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="va">dt</span>, compactify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">locf_omitted</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;geo_value, time_value, version&gt;</span></span>
<span><span class="co">#&gt;    geo_value time_value    version percent_cli case_rate_7d_av</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;       &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        ca 2020-06-01 2020-06-02          NA        6.628329</span></span>
<span><span class="co">#&gt; 2:        ca 2020-06-01 2020-06-06    2.140116        6.628329</span></span>
<span><span class="co">#&gt; 3:        ca 2020-06-01 2020-06-08    2.140379        6.628329</span></span>
<span><span class="co">#&gt; 4:        ca 2020-06-01 2020-06-09    2.114430        6.628329</span></span>
<span><span class="co">#&gt; 5:        ca 2020-06-01 2020-06-10    2.133677        6.628329</span></span>
<span><span class="co">#&gt; 6:        ca 2020-06-01 2020-06-11    2.197207        6.628329</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">locf_included</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;geo_value, time_value, version&gt;</span></span>
<span><span class="co">#&gt;    geo_value time_value    version percent_cli case_rate_7d_av</span></span>
<span><span class="co">#&gt;       &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;       &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:        ca 2020-06-01 2020-06-02          NA        6.628329</span></span>
<span><span class="co">#&gt; 2:        ca 2020-06-01 2020-06-06    2.140116        6.628329</span></span>
<span><span class="co">#&gt; 3:        ca 2020-06-01 2020-06-07    2.140116        6.628329</span></span>
<span><span class="co">#&gt; 4:        ca 2020-06-01 2020-06-08    2.140379        6.628329</span></span>
<span><span class="co">#&gt; 5:        ca 2020-06-01 2020-06-09    2.114430        6.628329</span></span>
<span><span class="co">#&gt; 6:        ca 2020-06-01 2020-06-10    2.133677        6.628329</span></span></code></pre></div>
<p>LOCF-redundant values can mar the performance of dataset operations.
As the column <code>case_rate_7d_av</code> has many more LOCF-redundant
values than <code>percent_cli</code>, we will omit the
<code>percent_cli</code> column for comparing performance.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">dt</span>, <span class="op">-</span><span class="va">percent_cli</span><span class="op">)</span></span>
<span></span>
<span><span class="va">locf_included_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="va">dt2</span>, compactify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">locf_omitted_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="va">dt2</span>, compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>In this example, a huge proportion of the original version update
data were LOCF-redundant, and compactifying saves a large amount of
space. The proportion of data that is LOCF-redundant can vary widely
between data sets, so we won’t always be this lucky.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">locf_included_2</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 129638</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">locf_omitted_2</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 9382</span></span></code></pre></div>
<p>As we would expect, performing 1000 iterations of
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> is faster when the LOCF values are
omitted.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Performance of filtering</span></span>
<span><span class="va">iterate_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">my_ea</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">my_ea</span><span class="op">$</span><span class="va">DT</span>, <span class="va">version</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="va">i</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">elapsed_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fx</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">fx</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">speed_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    operation <span class="op">=</span> <span class="va">name</span>,</span>
<span>    locf <span class="op">=</span> <span class="fu">elapsed_time</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">locf_included_2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    no_locf <span class="op">=</span> <span class="fu">elapsed_time</span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">locf_omitted_2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">speeds</span> <span class="op">&lt;-</span> <span class="fu">speed_test</span><span class="op">(</span><span class="va">iterate_filter</span>, <span class="st">"filter_1000x"</span><span class="op">)</span></span></code></pre></div>
<p>We would also like to measure the speed of <code>epi_archive</code>
methods.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Performance of as_of iterated 200 times</span></span>
<span><span class="va">iterate_as_of</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">my_ea</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">my_ea</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">my_ea</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">time_value</span><span class="op">)</span> <span class="op">+</span> <span class="va">i</span> <span class="op">-</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">speeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">speeds</span>, <span class="fu">speed_test</span><span class="op">(</span><span class="va">iterate_as_of</span>, <span class="st">"as_of_1000x"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Performance of slide</span></span>
<span><span class="va">slide_median</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">my_ea</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">my_ea</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span><span class="op">(</span>median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">case_rate_7d_av</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">speeds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">speeds</span>, <span class="fu">speed_test</span><span class="op">(</span><span class="va">slide_median</span>, <span class="st">"slide_median"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here is a detailed performance comparison:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speeds_tidy</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">speeds</span>, key <span class="op">=</span> <span class="st">"is_locf"</span>, value <span class="op">=</span> <span class="st">"time_in_s"</span>, <span class="va">locf</span>, <span class="va">no_locf</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">speeds_tidy</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">is_locf</span>, y <span class="op">=</span> <span class="va">time_in_s</span>, fill <span class="op">=</span> <span class="va">operation</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span></span></code></pre></div>
<p><img src="compactify_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epiprocess</p>
</div>

    </footer>
</div>





  </body>
</html>
