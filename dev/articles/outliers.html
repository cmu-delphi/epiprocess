<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Detect and correct outliers in signals • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Detect and correct outliers in signals">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.11.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epiprocess.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/epi_df.html">Working with epi_df objects and time series data</a></li>
    <li><a class="dropdown-item" href="../articles/epi_archive.html">Working with epi_archive objects and data revisions</a></li>
    <li><a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a></li>
    <li><a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a></li>
    <li><a class="dropdown-item" href="../articles/correlation.html">Correlate signals across locations and time</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Detect and correct outliers in signals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/dev/vignettes/outliers.Rmd" class="external-link"><code>vignettes/outliers.Rmd</code></a></small>
      <div class="d-none name"><code>outliers.Rmd</code></div>
    </div>

    
    
<p>This vignette describes functionality for detecting and correcting
outliers in signals in the <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code> and
<code>correct_outlr()</code> functions provided in the
<code>epiprocess</code> package. These functions are designed to be
modular and extendable, so that you can define your own outlier
detection and correction routines and apply them to <code>epi_df</code>
objects. We’ll demonstrate this using state-level daily reported
COVID-19 case counts from FL and NJ.</p>
<p>The dataset has 730 rows and 3 columns.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epiprocess" class="external-link">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">covid_incidence_outliers</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-3-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>There are multiple outliers in these data that a modeler may want to
detect and correct. We’ll discuss those two tasks in turn.</p>
<div class="section level2">
<h2 id="outlier-detection">Outlier detection<a class="anchor" aria-label="anchor" href="#outlier-detection"></a>
</h2>
<p>The <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code> function allows us to run multiple
outlier detection methods on a given signal, and then (optionally)
combine the results from those methods. Here, we’ll investigate outlier
detection results from the following methods.</p>
<ol style="list-style-type: decimal">
<li>Detection based on a rolling median, using
<code><a href="../reference/detect_outlr.html">detect_outlr_rm()</a></code>, which computes a rolling median on with
a default window size of <code>n</code> time points centered at the time
point under consideration, and then computes thresholds based on a
multiplier times a rolling IQR computed on the residuals.</li>
<li>Detection based on a seasonal-trend decomposition using LOESS (STL),
using <code><a href="../reference/detect_outlr.html">detect_outlr_stl()</a></code>, which is similar to the rolling
median method but replaces the rolling median with fitted values from
STL.</li>
<li>Detection based on an STL decomposition, but subtracting out the
seasonality term from its predictions, which may result in the extrema
of large seasonal variations being considered as outliers.</li>
</ol>
<p>The outlier detection methods are specified using a
<code>tibble</code> that is passed to <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code>, with
one row per method, and whose columms specify the outlier detection
function, any input arguments (only nondefault values need to be
supplied), and an abbreviated name for the method used in tracking
results. Abbreviations “rm” and “stl” can be used for the built-in
detection functions <code><a href="../reference/detect_outlr.html">detect_outlr_rm()</a></code> and
<code><a href="../reference/detect_outlr.html">detect_outlr_stl()</a></code>, respectively.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">detection_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"rm"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      detection_multiplier <span class="op">=</span> <span class="fl">2.5</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>    abbr <span class="op">=</span> <span class="st">"rm"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"stl"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      detection_multiplier <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>      seasonal_period <span class="op">=</span> <span class="fl">7</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>    abbr <span class="op">=</span> <span class="st">"stl_seasonal"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"stl"</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      detection_multiplier <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>      seasonal_period <span class="op">=</span> <span class="fl">7</span>,</span>
<span>      seasonal_as_residual <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span><span class="op">)</span>,</span>
<span>    abbr <span class="op">=</span> <span class="st">"stl_reseasonal"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">detection_methods</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 3</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">method</span> <span style="font-weight: bold;">args</span>             <span style="font-weight: bold;">abbr</span>          </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rm     <span style="color: #949494;">&lt;named list [2]&gt;</span> rm            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> stl    <span style="color: #949494;">&lt;named list [3]&gt;</span> stl_seasonal  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> stl    <span style="color: #949494;">&lt;named list [4]&gt;</span> stl_reseasonal</span></span></code></pre></div>
<p>Additionally, we’ll form combined lower and upper thresholds,
calculated as the median of the lower and upper thresholds from the
methods at each time point. Note that using this combined median
threshold is equivalent to using a majority vote across the base methods
to determine whether a value is an outlier.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    outlier_info <span class="op">=</span> <span class="fu"><a href="../reference/detect_outlr.html">detect_outlr</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">time_value</span>,</span>
<span>      y <span class="op">=</span> <span class="va">cases</span>,</span>
<span>      methods <span class="op">=</span> <span class="va">detection_methods</span>,</span>
<span>      combiner <span class="op">=</span> <span class="st">"median"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">outlier_info</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 6 x 15 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2021-10-28</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 15</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">cases</span> <span style="font-weight: bold;">rm_lower</span> <span style="font-weight: bold;">rm_upper</span> <span style="font-weight: bold;">rm_replacement</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> fl        2020-06-01   667    345      <span style="text-decoration: underline;">2</span>195             667</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> nj        2020-06-01   486     64.4     926.            486</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> fl        2020-06-02   617    406.     <span style="text-decoration: underline;">2</span>169.            617</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> nj        2020-06-02   658    140.      841.            658</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> fl        2020-06-03  <span style="text-decoration: underline;">1</span>317    468.     <span style="text-decoration: underline;">2</span>142.           <span style="text-decoration: underline;">1</span>317</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> nj        2020-06-03   541    216       756             541</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 9 more variables: </span><span style="color: #949494; font-weight: bold;">stl_seasonal_lower</span><span style="color: #949494;"> &lt;dbl&gt;, </span><span style="color: #949494; font-weight: bold;">stl_seasonal_upper</span><span style="color: #949494;"> &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   </span><span style="color: #949494; font-weight: bold;">stl_seasonal_replacement</span><span style="color: #949494;"> &lt;dbl&gt;, </span><span style="color: #949494; font-weight: bold;">stl_reseasonal_lower</span><span style="color: #949494;"> &lt;dbl&gt;, …</span></span></span></code></pre></div>
<p>To visualize the results, we first define a convenience function for
plotting.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot outlier detection bands and/or points identified as outliers</span></span>
<span><span class="va">plot_outlr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">signal</span>, <span class="va">method_abbr</span>, <span class="va">bands</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">points</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       <span class="va">facet_vars</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">geo_value</span><span class="op">)</span>, <span class="va">nrow</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">ncol</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       <span class="va">scales</span> <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Convert outlier detection results to long format</span></span>
<span>  <span class="va">signal</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span>  <span class="va">x_long</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="va">method_abbr</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"method"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>      names_pattern <span class="op">=</span> <span class="st">"(.+)_(.+)"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Start of plot with observed data</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">time_value</span>, y <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">signal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If requested, add bands</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">bands</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">x_long</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">time_value</span>, ymin <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">upper</span>,</span>
<span>        color <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">method</span></span>
<span>      <span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># If requested, add points</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">points</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x_detected</span> <span class="op">&lt;-</span> <span class="va">x_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">signal</span> <span class="op">&lt;</span> <span class="va">.data</span><span class="op">$</span><span class="va">lower</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">signal</span> <span class="op">&gt;</span> <span class="va">.data</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">x_detected</span>,</span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>        x <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">time_value</span>, y <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">signal</span>, color <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">method</span>,</span>
<span>        shape <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">method</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># If requested, add faceting</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">facet_vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">facet_vars</span>, nrow <span class="op">=</span> <span class="va">nrow</span>, ncol <span class="op">=</span> <span class="va">ncol</span>, scales <span class="op">=</span> <span class="va">scales</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we produce plots for each state at a time, faceting by the
detection method.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method_abbr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">detection_methods</span><span class="op">$</span><span class="va">abbr</span>, <span class="st">"combined"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_outlr</span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="st">"fl"</span><span class="op">)</span>, <span class="va">cases</span>, <span class="va">method_abbr</span>,</span>
<span>  facet_vars <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span>, color <span class="op">=</span> <span class="st">"Method"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"Method"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">plot_outlr</span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="st">"nj"</span><span class="op">)</span>, <span class="va">cases</span>, <span class="va">method_abbr</span>,</span>
<span>  facet_vars <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span>, color <span class="op">=</span> <span class="st">"Method"</span>,</span>
<span>    shape <span class="op">=</span> <span class="st">"Method"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-7-2.png" width="90%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="outlier-correction">Outlier correction<a class="anchor" aria-label="anchor" href="#outlier-correction"></a>
</h2>
<p>Finally, in order to correct outliers, we can use the posited
replacement values returned by each outlier detection method. Below we
use the replacement value from the combined method, which is defined by
the median of replacement values from the base methods at each time
point.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cases_corrected <span class="op">=</span> <span class="va">combined_replacement</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">cases</span>, <span class="va">cases_corrected</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">!=</span> <span class="va">cases_corrected</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 22 x 4 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2021-10-28</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 4</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">cases</span> <span style="font-weight: bold;">cases_corrected</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> fl        2020-07-12 <span style="text-decoration: underline;">15</span>300          <span style="text-decoration: underline;">10</span>181 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> nj        2020-07-19    -<span style="color: #BB0000;">8</span>            320.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> nj        2020-08-13   694            404.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> nj        2020-08-14   619            397.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> nj        2020-08-16    40            366 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> nj        2020-08-22   555            360 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 16 more rows</span></span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases_corrected</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-8-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>More advanced correction functionality will be coming at some point
in the future.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This document contains a dataset that is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data
Repository by the Center for Systems Science and Engineering (CSSE) at
Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished
in the COVIDcast Epidata API</a>. This data set is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
<p><a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">From
the COVIDcast Epidata API</a>: These signals are taken directly from the
JHU CSSE <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19
GitHub repository</a> without changes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epiprocess</p>
</div>

    </footer>
</div>





  </body>
</html>
