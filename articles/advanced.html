<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epiprocess">
<title>Advanced sliding with nonstandard outputs • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced sliding with nonstandard outputs">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/epiprocess.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/slide.html">Slide a computation over signal values</a>
    <a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    <a class="dropdown-item" href="../articles/correlation.html">Correlate signals over space and time</a>
    <a class="dropdown-item" href="../articles/aggregation.html">Aggregate signals over space and time</a>
    <a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a>
    <a class="dropdown-item" href="../articles/archive.html">Work with archive objects and data revisions</a>
    <a class="dropdown-item" href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/tree/main/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="advanced_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Advanced sliding with nonstandard outputs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/advanced.Rmd" class="external-link"><code>vignettes/advanced.Rmd</code></a></small>
      <div class="d-none name"><code>advanced.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we discuss how to use the sliding functionality in the <code>epiprocess</code> package with computations that have advanced output structures.</p>
<p>In general, the functions <code><a href="../reference/epi_slide.html">epi_slide()</a></code> and <code><a href="../reference/epix_slide.html">epix_slide()</a></code> do what they can to ensure the result of a slide operation is <em>size stable</em>, meaning, it will return something whose length is the same as the number of appearances of reference time values for the slide computation in the given data frame/table (this defaults to all time values, but can be some given subset when <code>ref_time_values</code> is specified).</p>
<p>The output of a slide computation should either be an atomic value/vector, or a data frame. This data frame can have multiple columns, multiple rows, or both. Below we demonstrate some advanced use cases of sliding with these output structures. We focus on <code><a href="../reference/epi_slide.html">epi_slide()</a></code> for the most part, though the behavior we demonstrate also carries over to <code><a href="../reference/epix_slide.html">epix_slide()</a></code>.</p>
<div class="section level2">
<h2 id="recycling-outputs">Recycling outputs<a class="anchor" aria-label="anchor" href="#recycling-outputs"></a>
</h2>
<p>When a computation returns a single atomic value, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will internally try to recycle the output so that it is size stable (in the sense described above). We can use this to our advantage, for example, in order to compute a trailing average marginally over geo values, which we demonstrate below in a simple synthetic example.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
  geo_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ca"</span>, <span class="st">"fl"</span>, <span class="st">"pa"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
  time_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-03"</span><span class="op">)</span>,
                       by <span class="op">=</span> <span class="st">"day"</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span>,
  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.01</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span><span class="op">)</span>,
<span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># 2-day trailing average, per geo value</span>
<span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 4</span></span>
<span class="co">## <span style="color: #949494;"># Groups:   geo_value [3]</span></span>
<span class="co">##   geo_value time_value     x x_2dav</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01   1.01</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> ca        2020-06-02  2.01   1.51</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> ca        2020-06-03  2.98   2.50</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> fl        2020-06-01  4.00   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> fl        2020-06-03  5.99   5.51</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> pa        2020-06-01  7.00   7.00</span>
<span class="co">## <span style="color: #BCBCBC;">8</span> pa        2020-06-02  8.02   7.51</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00   8.51</span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># 2-day trailing average, marginally </span>
<span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 4</span></span>
<span class="co">##   geo_value time_value     x x_2dav</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> fl        2020-06-01  4.00   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> pa        2020-06-01  7.00   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> ca        2020-06-02  2.01   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> pa        2020-06-02  8.02   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> ca        2020-06-03  2.98   5.50</span>
<span class="co">## <span style="color: #BCBCBC;">8</span> fl        2020-06-03  5.99   5.50</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00   5.50</span></code></pre>
<p>When the slide computation returns an atomic vector (rather than a single value) <code><a href="../reference/epi_slide.html">epi_slide()</a></code> checks whether its return length ensures size stability, and if so, uses it to fill the new column. For example, this next computation gives the same result as the last one.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>y_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 4</span></span>
<span class="co">##   geo_value time_value     x y_2dav</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> fl        2020-06-01  4.00   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> pa        2020-06-01  7.00   4.00</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> ca        2020-06-02  2.01   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> pa        2020-06-02  8.02   4.51</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> ca        2020-06-03  2.98   5.50</span>
<span class="co">## <span style="color: #BCBCBC;">8</span> fl        2020-06-03  5.99   5.50</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00   5.50</span></code></pre>
<p>However, if the output is an atomic vector (rather than a single value) and it is <em>not</em> size stable, then <code><a href="../reference/epi_slide.html">epi_slide()</a></code> throws an error. For example, below we are trying to return 2 things for 3 states.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `Abort()`:</span></span>
<span class="co">## <span style="color: #BBBB00;">!</span> If the slide computations return atomic vectors, then they must each</span>
<span class="co">## have a single element, or else one element per appearance of the reference</span>
<span class="co">## time value in the local window.</span></code></pre>
</div>
<div class="section level2">
<h2 id="multi-column-outputs">Multi-column outputs<a class="anchor" aria-label="anchor" href="#multi-column-outputs"></a>
</h2>
<p>Now we move on to outputs that are data frames with a single row but multiple columns. Working with this type of output structure has in fact has already been demonstrated in the <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">slide vignette</a>. When we set <code>as_list_col = TRUE</code> in the call to <code><a href="../reference/epi_slide.html">epi_slide()</a></code>, the resulting <code>epi_df</code> object returned by <code><a href="../reference/epi_slide.html">epi_slide()</a></code> has a list column containing the slide values.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, x_2dma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html" class="external-link">mad</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fl">2</span>, as_list_col <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">df2</span><span class="op">$</span><span class="va">a</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "list"</span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">df2</span><span class="op">$</span><span class="va">a</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 9</span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df2</span><span class="op">$</span><span class="va">a</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></code></pre></div>
<pre><code><span class="co">##     x_2dav    x_2dma</span>
<span class="co">## 1 1.513183 0.7396857</span></code></pre>
<p>When we use <code>as_list_col = FALSE</code> (the default in <code><a href="../reference/epi_slide.html">epi_slide()</a></code>), the function unnests (in the sense of <code><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">tidyr::unnest()</a></code>) the list column <code>a</code>, so that the resulting <code>epi_df</code> has multiple new columns containing the slide values. The default is to name these unnested columns by prefixing the name assigned to the list column (here <code>a</code>) onto the column names of the output data frame from the slide computation (here <code>x_2dav</code> and <code>x_2dma</code>) separated by "_".</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, x_2dma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html" class="external-link">mad</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fl">2</span>, as_list_col <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 5</span></span>
<span class="co">## <span style="color: #949494;"># Groups:   geo_value [3]</span></span>
<span class="co">##   geo_value time_value     x a_x_2dav a_x_2dma</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01     1.01    0    </span>
<span class="co">## <span style="color: #BCBCBC;">2</span> ca        2020-06-02  2.01     1.51    0.740</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> ca        2020-06-03  2.98     2.50    0.719</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> fl        2020-06-01  4.00     4.00    0    </span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02     4.51    0.758</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> fl        2020-06-03  5.99     5.51    0.719</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> pa        2020-06-01  7.00     7.00    0    </span>
<span class="co">## <span style="color: #BCBCBC;">8</span> pa        2020-06-02  8.02     7.51    0.755</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00     8.51    0.728</span></code></pre>
<p>We can use <code>names_sep = NULL</code> (which gets passed to <code><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">tidyr::unnest()</a></code>) to drop the prefix associated with list column name, in naming the unnested columns.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, x_2dma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html" class="external-link">mad</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fl">2</span>, as_list_col <span class="op">=</span> <span class="cn">FALSE</span>, names_sep <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 5</span></span>
<span class="co">## <span style="color: #949494;"># Groups:   geo_value [3]</span></span>
<span class="co">##   geo_value time_value     x x_2dav x_2dma</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01   1.01  0    </span>
<span class="co">## <span style="color: #BCBCBC;">2</span> ca        2020-06-02  2.01   1.51  0.740</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> ca        2020-06-03  2.98   2.50  0.719</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> fl        2020-06-01  4.00   4.00  0    </span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02   4.51  0.758</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> fl        2020-06-03  5.99   5.51  0.719</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> pa        2020-06-01  7.00   7.00  0    </span>
<span class="co">## <span style="color: #BCBCBC;">8</span> pa        2020-06-02  8.02   7.51  0.755</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00   8.51  0.728</span></code></pre>
<p>Furthermore, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will recycle the single row data frame as needed in order to make the result size stable, just like the case for atomic values.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x_2dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, x_2dma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/mad.html" class="external-link">mad</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,
            n <span class="op">=</span> <span class="fl">2</span>, as_list_col <span class="op">=</span> <span class="cn">FALSE</span>, names_sep <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 5</span></span>
<span class="co">##   geo_value time_value     x x_2dav x_2dma</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01   4.00   4.42</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> fl        2020-06-01  4.00   4.00   4.42</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> pa        2020-06-01  7.00   4.00   4.42</span>
<span class="co">## <span style="color: #BCBCBC;">4</span> ca        2020-06-02  2.01   4.51   3.70</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02   4.51   3.70</span>
<span class="co">## <span style="color: #BCBCBC;">6</span> pa        2020-06-02  8.02   4.51   3.70</span>
<span class="co">## <span style="color: #BCBCBC;">7</span> ca        2020-06-03  2.98   5.50   3.73</span>
<span class="co">## <span style="color: #BCBCBC;">8</span> fl        2020-06-03  5.99   5.50   3.73</span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00   5.50   3.73</span></code></pre>
</div>
<div class="section level2">
<h2 id="multi-row-outputs">Multi-row outputs<a class="anchor" aria-label="anchor" href="#multi-row-outputs"></a>
</h2>
<p>For a slide computation that outputs a data frame with more than one row, the behavior is analogous to a slide computation that outputs an atomic vector. Meaning, <code><a href="../reference/epi_slide.html">epi_slide()</a></code> will check that the result is size stable, and if so, will fill the new column(s) in the resulting <code>epi_df</code> object appropriately.</p>
<p>This can be convenient for modeling in the following sense: we can, for example, fit a sliding forecasting model by pooling data from different locations, and then return separate forecasts from this common model for each location. We use our synthetic example to demonstrate this idea abstractly but simply.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">df</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>

<span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">obj</span>, newdata <span class="op">=</span> <span class="va">d</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>, 
                interval <span class="op">=</span> <span class="st">"prediction"</span>, level <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>
      <span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>, n <span class="op">=</span> <span class="fl">2</span>, new_col_name <span class="op">=</span> <span class="st">"fc"</span>, names_sep <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## An `epi_df` object, with metadata:</span>
<span class="co">## * geo_type  = state</span>
<span class="co">## * time_type = day</span>
<span class="co">## * as_of     = 2022-06-29 02:59:02</span>
<span class="co">## </span>
<span class="co">## <span style="color: #949494;"># A tibble: 9 × 7</span></span>
<span class="co">##   geo_value time_value     x     y   fit   lwr   upr</span>
<span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01  1.01  2.09  2.09  2.05  2.13</span>
<span class="co">## <span style="color: #BCBCBC;">2</span> fl        2020-06-01  4.00  8.03  8.02  7.99  8.06</span>
<span class="co">## <span style="color: #BCBCBC;">3</span> pa        2020-06-01  7.00 14.0  14.0  14.0  14.0 </span>
<span class="co">## <span style="color: #BCBCBC;">4</span> ca        2020-06-02  2.01  3.97  4.03  3.91  4.15</span>
<span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-02  5.02 10.0  10.0   9.93 10.2 </span>
<span class="co">## <span style="color: #BCBCBC;">6</span> pa        2020-06-02  8.02 16.1  16.0  15.9  16.2 </span>
<span class="co">## <span style="color: #BCBCBC;">7</span> ca        2020-06-03  2.98  5.92  5.93  5.83  6.03</span>
<span class="co">## <span style="color: #BCBCBC;">8</span> fl        2020-06-03  5.99 12.0  12.0  11.9  12.1 </span>
<span class="co">## <span style="color: #BCBCBC;">9</span> pa        2020-06-03  9.00 18.0  18.0  17.9  18.1</span></code></pre>
</div>
<div class="section level2">
<h2 id="version-aware-forecasting-revisited">Version-aware forecasting, revisited<a class="anchor" aria-label="anchor" href="#version-aware-forecasting-revisited"></a>
</h2>
<p>Finally, we revisit the COVID-19 forecasting example from the <a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">archive vignette</a> in order to demonstrate the last point in a more realistic setting. First, we fetch the versioned data and build the archive.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/delphi-epidata-r" class="external-link">delphi.epidata</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">y1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span>
  data_source <span class="op">=</span> <span class="st">"doctor-visits"</span>,
  signals <span class="op">=</span> <span class="st">"smoothed_adj_cli"</span>,
  time_type <span class="op">=</span> <span class="st">"day"</span>,
  geo_type <span class="op">=</span> <span class="st">"state"</span>,
  time_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,
  geo_values <span class="op">=</span> <span class="st">"ca,fl"</span>,
  issues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span>
  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,
  signal <span class="op">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,
  time_type <span class="op">=</span> <span class="st">"day"</span>,
  geo_type <span class="op">=</span> <span class="st">"state"</span>,
  time_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,
  geo_values <span class="op">=</span> <span class="st">"ca,fl"</span>,
  issues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>
<span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/delphi.epidata/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="va">y1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>,
    version <span class="op">=</span> <span class="va">issue</span>,
    percent_cli <span class="op">=</span> <span class="va">value</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="../reference/epix_merge.html">epix_merge</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>,
    version <span class="op">=</span> <span class="va">issue</span>,
    case_rate_7d_av <span class="op">=</span> <span class="va">value</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span><span class="op">)</span>,
all <span class="op">=</span> <span class="cn">TRUE</span>
<span class="op">)</span></code></pre></div>
<p>Next, we extend the ARX function to handle multiple geo values, since in the present case, we will not be grouping by geo value and each slide computation will be run on multiple geo values at once. Note that, because <code><a href="../reference/epix_slide.html">epix_slide()</a></code> only returns the grouping variables, <code>time_value</code>, and the slide computations in the eventual returned tibble, we need to include <code>geo_value</code> as a column in the output data frame from our ARX computation.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org" class="external-link">purrr</a></span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">## Attaching package: 'purrr'</span></code></pre>
<pre><code><span class="co">## The following object is masked from 'package:data.table':</span>
<span class="co">## </span>
<span class="co">##     transpose</span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prob_arx_args</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, 
                          <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, 
                          <span class="va">min_train_window</span> <span class="op">=</span> <span class="fl">20</span>,
                          <span class="va">lower_level</span> <span class="op">=</span> <span class="fl">0.05</span>, 
                          <span class="va">upper_level</span> <span class="op">=</span> <span class="fl">0.95</span>, 
                          <span class="va">symmetrize</span> <span class="op">=</span> <span class="cn">TRUE</span>, 
                          <span class="va">intercept</span> <span class="op">=</span> <span class="cn">FALSE</span>,
                          <span class="va">nonneg</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lags <span class="op">=</span> <span class="va">lags</span>, 
              ahead <span class="op">=</span> <span class="va">ahead</span>, 
              min_train_window <span class="op">=</span> <span class="va">min_train_window</span>,
              lower_level <span class="op">=</span> <span class="va">lower_level</span>,
              upper_level <span class="op">=</span> <span class="va">upper_level</span>,
              symmetrize <span class="op">=</span> <span class="va">symmetrize</span>, 
              intercept <span class="op">=</span> <span class="va">intercept</span>,
              nonneg <span class="op">=</span> <span class="va">nonneg</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">prob_arx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">args</span> <span class="op">=</span> <span class="fu">prob_arx_args</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>  
  <span class="co"># Return NA if insufficient training data</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">args</span><span class="op">$</span><span class="va">min_train_window</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">lags</span><span class="op">)</span> <span class="op">+</span> <span class="va">args</span><span class="op">$</span><span class="va">ahead</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="co"># Return geo value!</span>
                      point <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># Set up x, y, lags list</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="kw">else</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">lags</span><span class="op">)</span><span class="op">)</span> <span class="va">args</span><span class="op">$</span><span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">lags</span><span class="op">)</span>
  <span class="va">args</span><span class="op">$</span><span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">lags</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Build features and response for the AR model, and then fit it</span>
  <span class="va">dat</span> <span class="op">&lt;-</span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, lag <span class="op">=</span> <span class="va">args</span><span class="op">$</span><span class="va">lags</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">lag</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="co"># One list element for each lagged feature</span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">pmap</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">lag</span>, <span class="va">name</span><span class="op">)</span> <span class="op">{</span>
      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="va">geo_value</span>,
             time_value <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">lag</span>, <span class="co"># Shift back </span>
             <span class="op">!</span><span class="op">!</span><span class="va">name</span> <span class="op">:=</span> <span class="va">x</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># One list element for the response vector</span>
    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
      <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="va">geo_value</span>,
             time_value <span class="op">=</span> <span class="va">time_value</span> <span class="op">-</span> <span class="va">args</span><span class="op">$</span><span class="va">ahead</span>, <span class="co"># Shift forward </span>
             y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="co"># Combine them together into one data frame</span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">full_join</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">intercept</span><span class="op">)</span> <span class="va">dat</span><span class="op">$</span><span class="va">x0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span>
  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">dat</span>, <span class="op">-</span><span class="va">geo_value</span>, <span class="op">-</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Use LOCF to fill NAs in the latest feature values (do this by geo value)</span>
  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="co"># Convert to a data.table object by reference</span>
  <span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"geo_value"</span>, <span class="st">"time_value"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">dat</span><span class="op">[</span>, <span class="op">(</span><span class="va">cols</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/nafill.html" class="external-link">nafill</a></span><span class="op">(</span><span class="va">.SD</span>, type <span class="op">=</span> <span class="st">"locf"</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="va">cols</span>, by <span class="op">=</span> <span class="st">"geo_value"</span><span class="op">]</span>
  
  <span class="co"># Make predictions</span>
  <span class="va">test_time_value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_value</span><span class="op">)</span>
  <span class="va">point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">obj</span>, newdata <span class="op">=</span> <span class="va">dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
                     <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
                     <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time_value</span> <span class="op">==</span> <span class="va">test_time_value</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Compute bands</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">symmetrize</span>, <span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># Should the residuals be symmetrized?</span>
  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">s</span> <span class="op">*</span> <span class="va">r</span><span class="op">)</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">lower</span>, <span class="va">args</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  
  <span class="co"># Clip at zero if we need to, then return</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">args</span><span class="op">$</span><span class="va">nonneg</span><span class="op">)</span> <span class="op">{</span> 
    <span class="va">point</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">point</span>, <span class="fl">0</span><span class="op">)</span> 
    <span class="va">lower</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">lower</span>, <span class="fl">0</span><span class="op">)</span> 
    <span class="va">upper</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">upper</span>, <span class="fl">0</span><span class="op">)</span> 
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>geo_value <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="co"># Return geo value!</span>
                    point <span class="op">=</span> <span class="va">point</span>, lower <span class="op">=</span> <span class="va">lower</span>, upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We now make forecasts on the archive and compare to forecasts on the latest data.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Latest snapshot of data, and forecast dates</span>
<span class="va">x_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">x</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>
<span class="va">fc_time_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span>, 
                      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, 
                      by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span>

<span class="co"># Simple function to produce forecasts k weeks ahead</span>
<span class="va">k_week_ahead</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">as_of</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">as_of</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_arx</span><span class="op">(</span><span class="va">percent_cli</span>, <span class="va">case_rate_7d_av</span>, <span class="va">geo_value</span>, <span class="va">time_value</span>, 
                               args <span class="op">=</span> <span class="fu">prob_arx_args</span><span class="op">(</span>ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span><span class="op">)</span>, 
                 n <span class="op">=</span> <span class="fl">120</span>, ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">ahead</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span>, 
             geo_value <span class="op">=</span> <span class="va">fc_geo_value</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">else</span> <span class="op">{</span>
    <span class="va">x_latest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
      <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_arx</span><span class="op">(</span><span class="va">percent_cli</span>, <span class="va">case_rate_7d_av</span>, <span class="va">geo_value</span>, <span class="va">time_value</span>, 
                              args <span class="op">=</span> <span class="fu">prob_arx_args</span><span class="op">(</span>ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span><span class="op">)</span>, 
                n <span class="op">=</span> <span class="fl">120</span>, ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">ahead</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> 
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># Generate the forecasts, and bind them together</span>
<span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">7</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">14</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">21</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">28</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">7</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">14</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">21</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,
                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">28</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot them, on top of latest COVID-19 case rates </span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span>, fill <span class="op">=</span> <span class="va">as_of</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">fc_lower</span>, ymax <span class="op">=</span> <span class="va">fc_upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate_7d_av</span><span class="op">)</span>, 
               inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_point</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_point</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">as_of</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> </code></pre></div>
<p><img src="advanced_files/figure-html/unnamed-chunk-14-1.png" width="864"></p>
<p>We can see that these forecasts, which come from training an ARX model jointly over CA and FL, exhibit generally less variability and wider prediction bands compared to the ones from the archive vignette, which come from training a separate ARX model on each state. As in the archive vignette, we can see a difference between version-aware (right column) and -unaware (left column) forecasting, as well.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>The <code>case_rate_7d_av</code> data used in this document is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished in the COVIDcast Epidata API</a>. This data set is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons Attribution 4.0 International license</a> by the Johns Hopkins University on behalf of its Center for Systems Science in Engineering. Copyright Johns Hopkins University 2020.</p>
<p>The <code>percent_cli</code> data is a modified part of the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html" class="external-link">COVIDcast Epidata API Doctor Visits data</a>. This dataset is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons Attribution 4.0 International license</a>. Copyright Delphi Research Group at Carnegie Mellon University 2020.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Logan Brooks, Daniel McDonald, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
