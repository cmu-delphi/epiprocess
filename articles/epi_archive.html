<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with epi_archive objects and data revisions • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Serif_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with epi_archive objects and data revisions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.10.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/epiprocess.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/epi_df.html">Working with epi_df objects and time series data</a></li>
    <li><a class="dropdown-item" href="../articles/epi_archive.html">Working with epi_archive objects and data revisions</a></li>
    <li><a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a></li>
    <li><a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a></li>
    <li><a class="dropdown-item" href="../articles/correlation.html">Correlate signals across locations and time</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with epi_archive objects and data revisions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/vignettes/epi_archive.Rmd" class="external-link"><code>vignettes/epi_archive.Rmd</code></a></small>
      <div class="d-none name"><code>epi_archive.Rmd</code></div>
    </div>

    
    
<p>The <code>epi_archive</code> data structure provided by
<code>epiprocess</code> provides convenient ways to work with data sets
that are subject to revision (a common occurrence in the public health
space, as situational awareness improves). In comparison to an
<code>epi_df</code> object, which can viewed as a data snapshot at a
point in time, an <code>epi_archive</code> object stores the full
version history of a data set. Paying attention to data revisions can be
important for all sorts of downstream data analysis and modeling
tasks.</p>
<p>In this vignette we will:</p>
<ul>
<li>construct an <code>epi_archive</code> object from a data frame,</li>
<li>summarize revision behavior in the archive,</li>
<li>produce snapshots of the data in <code>epi_df</code> form,</li>
<li>merge <code>epi_archive</code> objects together,</li>
<li>provide a link to a backtesting forecasting models vignette.</li>
</ul>
<div class="section level2">
<h2 id="getting-data-into-epi_archive-format">Getting data into <code>epi_archive</code> format<a class="anchor" aria-label="anchor" href="#getting-data-into-epi_archive-format"></a>
</h2>
<p>We will work with a signal on the percentage of doctor’s visits with
CLI (COVID-like illness) computed from medical insurance claims,
available through the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html" class="external-link">COVIDcast
API</a>. This signal is subject to very heavy and regular revision; you
can read more about it on its <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html" class="external-link">API
documentation page</a>.</p>
<p>The data is included in this package (via the <a href="https://cmu-delphi.github.io/epidatasets/" class="external-link"><code>epidatasets</code>
package</a>) and can be loaded with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This fetches the raw data backing the archive_cases_dv_subset object.</span></span>
<span><span class="va">dv</span> <span class="op">&lt;-</span> <span class="va">archive_cases_dv_subset</span><span class="op">$</span><span class="va">DT</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The data can also be fetched from the Delphi Epidata API with the
following query:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"doctor-visits"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_adj_cli"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">issue</span>, percent_cli <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span></code></pre></div>
<p>An <code><a href="../reference/epi_archive.html">epi_archive()</a></code> object can be constructed from a data
frame, data table, or tibble, provided that it has (at least) the
following columns:</p>
<ul>
<li>
<code>geo_value</code>: the geographic value associated with each
row of measurements.</li>
<li>
<code>time_value</code>: the time value associated with each row of
measurements.</li>
<li>
<code>version</code>: the time value specifying the version for each
row of measurements. For example, if in a given row the
<code>version</code> is January 15, 2022 and <code>time_value</code> is
January 14, 2022, then this row contains the measurements of the data
for January 14, 2022 that were available one day later.</li>
</ul>
<p>As we can see from the above, the data frame returned by
<code><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">epidatr::pub_covidcast()</a></code> has the columns required for the
<code>epi_archive</code> format, with <code>issue</code> playing the
role of <code>version</code>. We can now use
<code><a href="../reference/epi_archive.html">as_epi_archive()</a></code> to bring it into <code>epi_archive</code>
format.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dv_archive</span> <span class="op">&lt;-</span> <span class="va">dv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">version</span>, <span class="va">percent_cli</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">dv_archive</span></span>
<span><span class="co">#&gt; → An `epi_archive` object, with metadata:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Min/max time values: 2020-06-01 / 2021-11-30</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> First/last version with update: 2020-06-02 / 2021-12-01</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Versions end: 2021-12-01</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> A preview of the table (119316 rows x 4 columns):</span></span>
<span><span class="co">#&gt; Key: &lt;geo_value, time_value, version&gt;</span></span>
<span><span class="co">#&gt;         geo_value time_value    version percent_cli</span></span>
<span><span class="co">#&gt;            &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt;      1:        ca 2020-06-01 2020-06-02          NA</span></span>
<span><span class="co">#&gt;      2:        ca 2020-06-01 2020-06-06    2.140116</span></span>
<span><span class="co">#&gt;      3:        ca 2020-06-01 2020-06-08    2.140379</span></span>
<span><span class="co">#&gt;      4:        ca 2020-06-01 2020-06-09    2.114430</span></span>
<span><span class="co">#&gt;      5:        ca 2020-06-01 2020-06-10    2.133677</span></span>
<span><span class="co">#&gt;     ---                                            </span></span>
<span><span class="co">#&gt; 119312:        tx 2021-11-26 2021-11-29    1.858596</span></span>
<span><span class="co">#&gt; 119313:        tx 2021-11-27 2021-11-28          NA</span></span>
<span><span class="co">#&gt; 119314:        tx 2021-11-28 2021-11-29          NA</span></span>
<span><span class="co">#&gt; 119315:        tx 2021-11-29 2021-11-30          NA</span></span>
<span><span class="co">#&gt; 119316:        tx 2021-11-30 2021-12-01          NA</span></span></code></pre></div>
<p>See the <code><a href="../reference/epi_archive.html">epi_archive()</a></code> documentation for more information
about its internal structure.</p>
</div>
<div class="section level2">
<h2 id="producing-snapshots-in-epi_df-form">Producing snapshots in <code>epi_df</code> form<a class="anchor" aria-label="anchor" href="#producing-snapshots-in-epi_df-form"></a>
</h2>
<p>A key method of an <code>epi_archive</code> class is
<code><a href="../reference/epix_as_of.html">epix_as_of()</a></code>, which generates a snapshot of the archive in
<code>epi_df</code> format. This represents the most up-to-date values
of the signal variables as of a given version.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">dv_archive</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-06-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edf</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `epi_df` object, 1,460 x 3 with metadata:</span></span>
<span><span class="co">#&gt; * geo_type  = state</span></span>
<span><span class="co">#&gt; * time_type = day</span></span>
<span><span class="co">#&gt; * as_of     = 2021-06-01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,460 × 3</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">time_value</span> <span style="font-weight: bold;">percent_cli</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca        2020-06-01        2.75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ca        2020-06-02        2.57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ca        2020-06-03        2.48</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ca        2020-06-04        2.41</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ca        2020-06-05        2.57</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> ca        2020-06-06        2.63</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,454 more rows</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">edf</span><span class="op">$</span><span class="va">time_value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2021-05-31"</span></span></code></pre></div>
<p>Note that that the max time value in the <code>epi_df</code> object
is May 29, 2021, even though the specified version date was June 1, 2021
(note that the <code>as_of</code> field printed above helps us see the
date of the snapshot). From this we can infer that the doctor’s visits
signal was 2 days latent on June 1.</p>
<p>Now, let’s investigate how much this data was revised. We will plot
the most up-to-date version of the time series in black
(<code>edf_latest</code> below) and then overlay several revisions from
the archive, spaced one month apart, as colored lines
(<code>snapshots</code> below). We will also mark the version dates with
dotted vertical lines.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">edf_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">dv_archive</span>, <span class="va">dv_archive</span><span class="op">$</span><span class="va">versions_end</span><span class="op">)</span></span>
<span><span class="va">max_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dv_archive</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span></span>
<span><span class="va">versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-01"</span><span class="op">)</span>, <span class="va">max_version</span> <span class="op">-</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span><span class="va">monthly_snapshots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">versions</span>, <span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">dv_archive</span>, <span class="va">v</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">v</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>    <span class="va">edf_latest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">max_version</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>latest <span class="op">=</span> <span class="va">version</span> <span class="op">==</span> <span class="va">max_version</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">monthly_snapshots</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">latest</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span>, xintercept <span class="op">=</span> <span class="va">version</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"% of doctor's visits with CLI"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">monthly_snapshots</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">latest</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span><span class="op">)</span>,</span>
<span>    inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="epi_archive_files/figure-html/unnamed-chunk-6-1.png" width="90%" style="display: block; margin: auto;"></p>
<p>We can see some interesting and highly nontrivial revision behavior:
at some points in time the provisional data snapshots grossly
underestimate the latest curve (look in particular at Florida close to
the end of 2021), and at others they overestimate it (both states
towards the beginning of 2021), though not quite as dramatically.
Modeling the revision process, which is often called <em>backfill
modeling</em>, is an important statistical problem in it of itself.</p>
</div>
<div class="section level2">
<h2 id="summarizing-revision-behavior">Summarizing revision behavior<a class="anchor" aria-label="anchor" href="#summarizing-revision-behavior"></a>
</h2>
<p>There are many ways to examine how signals change across revisions.
We provide the convenient analysis wrapper
<code><a href="../reference/revision_summary.html">revision_summary()</a></code>, which computes simple summary
statistics for each key (by default, <code>(geo_value,time_value)</code>
pairs). In addition to the per key summary, it also returns an overall
summary. Here is an a sample of the output:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">revision_details</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/revision_summary.html">revision_summary</a></span><span class="op">(</span><span class="va">dv_archive</span>, print_inform <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Min lag (time to first version):</span></span>
<span><span class="co">#&gt;      min median     mean     max</span></span>
<span><span class="co">#&gt;   3 days 3 days 3.5 days 12 days</span></span>
<span><span class="co">#&gt; Fraction of epi_key+time_values with</span></span>
<span><span class="co">#&gt; No revisions:</span></span>
<span><span class="co">#&gt; • 0 out of 1,956 (0%)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Quick revisions (last revision within 3 days of the `time_value`):</span></span>
<span><span class="co">#&gt; • 0 out of 1,956 (0%)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Few revisions (At most 3 revisions for that `time_value`):</span></span>
<span><span class="co">#&gt; • 0 out of 1,956 (0%)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Fraction of revised epi_key+time_values which have:</span></span>
<span><span class="co">#&gt; Less than 0.1 spread in relative value:</span></span>
<span><span class="co">#&gt; • 91 out of 1,956 (4.65%)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Spread of more than 2.22056495 in actual value (when revised):</span></span>
<span><span class="co">#&gt; • 671 out of 1,956 (34.3%)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; days until within 20% of the latest value:</span></span>
<span><span class="co">#&gt;      min median     mean     max</span></span>
<span><span class="co">#&gt;   3 days 5 days 9.1 days 67 days</span></span></code></pre></div>
<p>We can see from the output that, as mentioned above, this data set
has a lot of revisions: there are no keys that have no revision at all
and 34% of the keys change by 10% or more when revised.</p>
<p>To do more detailed analysis than is possible with the above
printing, we can inspect the returned <code>revision_details</code>
tibble. Here we collect a number of statistics for each state:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">revision_details</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n_rev <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">n_revisions</span><span class="op">)</span>,</span>
<span>    min_lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">min_lag</span><span class="op">)</span>,</span>
<span>    max_lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">max_lag</span><span class="op">)</span>,</span>
<span>    spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">spread</span><span class="op">)</span>,</span>
<span>    rel_spread <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">rel_spread</span><span class="op">)</span>,</span>
<span>    time_near_latest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">time_near_latest</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 7</span></span></span>
<span><span class="co">#&gt;   <span style="font-weight: bold;">geo_value</span> <span style="font-weight: bold;">n_rev</span> <span style="font-weight: bold;">min_lag</span> <span style="font-weight: bold;">max_lag</span> <span style="font-weight: bold;">spread</span> <span style="font-weight: bold;">rel_spread</span> <span style="font-weight: bold;">time_near_latest</span></span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;drtn&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;drtn&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;drtn&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ca         56.4 3 days  74 days   2.53      0.304 11.278119 days  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> fl         56.4 3 days  74 days   2.29      0.280 10.830266 days  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ny         56.4 3 days  74 days   1.98      0.206  6.977505 days  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tx         56.4 3 days  74 days   1.63      0.218  7.398773 days</span></span></code></pre></div>
<p>Most of the states have similar stats on most of these features,
except for the <code>time_near_latest</code> stat, which is the amount
of time that it takes for the revisions to converge to within 20% of the
final value and stay there. It is the highest for CA and the lowest for
TX.</p>
</div>
<div class="section level2">
<h2 id="merging-epi_archive-objects">Merging <code>epi_archive</code> objects<a class="anchor" aria-label="anchor" href="#merging-epi_archive-objects"></a>
</h2>
<p>A common operation on datasets is merging (or joining) them together,
such as when we grab data from multiple sources for joint analysis or
modeling. Merging two <code>epi_archive</code> objects together is a bit
tricky however, since we need to handle datasets that might get revised
at different times. The function <code><a href="../reference/epix_merge.html">epix_merge()</a></code> is made to
smooth this out. Below we merge the working <code>epi_archive</code> of
versioned percentage CLI from outpatient visits to another one of
versioned COVID-19 case reporting data, which we fetch the from the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html/" class="external-link">COVIDcast
API</a>, on the rate scale (counts per 100,000 people in the
population).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epidatr/" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/pub_covidcast.html" class="external-link">pub_covidcast</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://cmu-delphi.github.io/epidatr/reference/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, version <span class="op">=</span> <span class="va">issue</span>, case_rate_7d_av <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dv_cases_archive</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_merge.html">epix_merge</a></span><span class="op">(</span><span class="va">dv_archive</span>, <span class="va">y</span>, sync <span class="op">=</span> <span class="st">"locf"</span>, compactify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dv_cases_archive</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; → An `epi_archive` object, with metadata:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Min/max time values: 2020-06-01 / 2021-11-30</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> First/last version with update: 2020-06-02 / 2021-12-01</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Versions end: 2021-12-01</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> A preview of the table (129638 rows x 5 columns):</span></span>
<span><span class="co">#&gt; Key: &lt;geo_value, time_value, version&gt;</span></span>
<span><span class="co">#&gt;         geo_value time_value    version percent_cli case_rate_7d_av</span></span>
<span><span class="co">#&gt;            &lt;char&gt;     &lt;Date&gt;     &lt;Date&gt;       &lt;num&gt;           &lt;num&gt;</span></span>
<span><span class="co">#&gt;      1:        ca 2020-06-01 2020-06-02          NA        6.628329</span></span>
<span><span class="co">#&gt;      2:        ca 2020-06-01 2020-06-06    2.140116        6.628329</span></span>
<span><span class="co">#&gt;      3:        ca 2020-06-01 2020-06-07    2.140116        6.628329</span></span>
<span><span class="co">#&gt;      4:        ca 2020-06-01 2020-06-08    2.140379        6.628329</span></span>
<span><span class="co">#&gt;      5:        ca 2020-06-01 2020-06-09    2.114430        6.628329</span></span>
<span><span class="co">#&gt;     ---                                                            </span></span>
<span><span class="co">#&gt; 129634:        tx 2021-11-26 2021-11-29    1.858596        7.957657</span></span>
<span><span class="co">#&gt; 129635:        tx 2021-11-27 2021-11-28          NA        7.174299</span></span>
<span><span class="co">#&gt; 129636:        tx 2021-11-28 2021-11-29          NA        6.834681</span></span>
<span><span class="co">#&gt; 129637:        tx 2021-11-29 2021-11-30          NA        8.841247</span></span>
<span><span class="co">#&gt; 129638:        tx 2021-11-30 2021-12-01          NA        9.566218</span></span></code></pre>
<p>Note that we have used the <code>sync = "locf"</code> argument to
specify that we want to synchronize the two datasets on their disjoint
revisions by using the last observation carried forward (LOCF). For more
information, see <code><a href="../reference/epix_merge.html">epix_merge()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="backtesting-forecasting-models">Backtesting forecasting models<a class="anchor" aria-label="anchor" href="#backtesting-forecasting-models"></a>
</h2>
<p>One of the most common use cases of
<code><a href="../reference/epi_archive.html">epiprocess::epi_archive()</a></code> object is for accurate model
backtesting. See
<code>vignette("backtesting", package="epipredict")</code> for an
in-depth demo, using a pre-built forecaster in that package.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This document contains a dataset that is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data
Repository by the Center for Systems Science and Engineering (CSSE) at
Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished
in the COVIDcast Epidata API</a>. This data set is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
<p>The <code>percent_cli</code> data is a modified part of the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html" class="external-link">COVIDcast
Epidata API Doctor Visits data</a>. This dataset is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a>. Copyright Delphi Research
Group at Carnegie Mellon University 2020.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><a href="https://delphi.cmu.edu/about/" class="external-link">About Delphi</a> • <a href="https://delphi.cmu.edu/epidemic-signals/terms-of-use/" class="external-link">Terms of Use</a> • <a href="https://docs.google.com/forms/u/1/d/e/1FAIpQLScqgT1fKZr5VWBfsaSp-DNaN03aV6EoZU4YljIzHJ1Wl_zmtg/viewform" class="external-link">Contact Us</a> • <a href="https://github.com/cmu-delphi/" class="external-link">Delphi GitHub</a> • <a href="https://cmu-delphi.github.io/delphi-epidata/" class="external-link">Epidata API</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>epiprocess</p>
</div>

    </footer>
</div>





  </body>
</html>
