<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epiprocess">
<title>Work with archive objects and data revisions • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Work with archive objects and data revisions">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0.9999</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/epiprocess.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/slide.html">Slide a computation over signal values</a>
    <a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    <a class="dropdown-item" href="../articles/correlation.html">Correlate signals over space and time</a>
    <a class="dropdown-item" href="../articles/aggregation.html">Aggregate signals over space and time</a>
    <a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a>
    <a class="dropdown-item" href="../articles/archive.html">Work with archive objects and data revisions</a>
    <a class="dropdown-item" href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
    <a class="dropdown-item" href="../articles/compactify.html">Compactify to remove redundant archive data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/tree/main/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Work with archive objects and data revisions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/archive.Rmd" class="external-link"><code>vignettes/archive.Rmd</code></a></small>
      <div class="d-none name"><code>archive.Rmd</code></div>
    </div>

    
    
<p>In addition to the <code>epi_df</code> data structure, which we have
been working with all along in these vignettes, the
<code>epiprocess</code> package has a companion structure called
<code>epi_archive</code>. In comparison to an <code>epi_df</code>
object, which can be seen as storing a single snapshot of a data set
with the most up-to-date signal values as of some given time, an
<code>epi_archive</code> object stores the full version history of a
data set. Many signals of interest for epidemiological tracking are
subject to revision (some more than others), and paying attention to
data revisions can be important for all sorts of downstream data
analysis and modeling tasks.</p>
<p>This vignette walks through working with <code>epi_archive</code>
objects and demonstrates some of their key functionality. We’ll work
with a signal on the percentage of doctor’s visits with CLI (COVID-like
illness) computed from medical insurance claims, available through the
<a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html" class="external-link">COVIDcast
API</a>. This signal is subject to very heavy and regular revision; you
can read more about it on its <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html" class="external-link">API
documentation page</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epidatr" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"doctor-visits"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"smoothed_adj_cli"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="getting-data-into-epi_archive-format">Getting data into <code>epi_archive</code> format<a class="anchor" aria-label="anchor" href="#getting-data-into-epi_archive-format"></a>
</h2>
<p>An
<code><a href="../reference/epi_archive.html">epi_archive</a></code>
object can be constructed from a data frame, data table, or tibble,
provided that it has (at least) the following columns:</p>
<ul>
<li>
<code>geo_value</code>: the geographic value associated with each
row of measurements.</li>
<li>
<code>time_value</code>: the time value associated with each row of
measurements.</li>
<li>
<code>version</code>: the time value specifying the version for each
row of measurements. For example, if in a given row the
<code>version</code> is January 15, 2022 and <code>time_value</code> is
January 14, 2022, then this row contains the measurements of the data
for January 14, 2022 that were available one day later.</li>
</ul>
<p>As we can see from the above, the data frame returned by
<code><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html" class="external-link">epidatr::covidcast()</a></code> has the columns required for the
<code>epi_archive</code> format, with <code>issue</code> playing the
role of <code>version</code>. We can now use
<code><a href="../reference/as_epi_archive.html">as_epi_archive()</a></code> to bring it into <code>epi_archive</code>
format. For removal of redundant version updates in
<code>as_epi_archive</code> using compactify, please refer to the
compactify vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">dv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, version <span class="op">=</span> <span class="va">issue</span>, percent_cli <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "epi_archive" "R6"</span></span></code></pre>
<pre><code><span><span class="co">## An `epi_archive` object, with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## * min time value = 2020-06-01</span></span>
<span><span class="co">## * max time value = 2021-11-30</span></span>
<span><span class="co">## * first version with update = 2020-06-02</span></span>
<span><span class="co">## * last version with update = 2021-12-01</span></span>
<span><span class="co">## * clobberable versions start = 2021-12-01</span></span>
<span><span class="co">## * versions end   = 2021-12-01</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Data archive (stored in DT field): 119316 x 4</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Columns in DT: geo_value, time_value, version, percent_cli</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Public methods: initialize, print, as_of, fill_through_version, merge, slide, clone</span></span>
<span><span class="co">## </span></span></code></pre>
<p>An <code>epi_archive</code> is special kind of class called an R6
class. Its primary field is a data table <code>DT</code>, which is of
class <code>data.table</code> (from the <code>data.table</code>
package), and has columns <code>geo_value</code>,
<code>time_value</code>, <code>version</code>, as well as any number of
additional columns.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "data.table" "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    geo_value time_value    version percent_cli</span></span>
<span><span class="co">## 1:        ca 2020-06-01 2020-06-02          NA</span></span>
<span><span class="co">## 2:        ca 2020-06-01 2020-06-06    2.140116</span></span>
<span><span class="co">## 3:        ca 2020-06-01 2020-06-08    2.140379</span></span>
<span><span class="co">## 4:        ca 2020-06-01 2020-06-09    2.114430</span></span>
<span><span class="co">## 5:        ca 2020-06-01 2020-06-10    2.133677</span></span>
<span><span class="co">## 6:        ca 2020-06-01 2020-06-11    2.197207</span></span></code></pre>
<p>The variables <code>geo_value</code>, <code>time_value</code>,
<code>version</code> serve as <strong>key variables</strong> for the
data table, as well as any other specified in the metadata (described
below). There can only be a single row per unique combination of key
variables, and therefore the key variables are critical for figuring out
how to generate a snapshot of data from the archive, as of a given
version (also described below).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "geo_value"  "time_value" "version"</span></span></code></pre>
<p>In general, the last version of each observation is carried forward
(LOCF) to fill in data between recorded versions. <strong>A word of
caution:</strong> R6 objects, unlike most other objects in R, have
reference semantics. An important consequence of this is that objects
are not copied when modified.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">original_value</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">percent_cli</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="co"># This DOES NOT make a copy of x</span></span>
<span><span class="va">y</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">percent_cli</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    geo_value time_value    version percent_cli</span></span>
<span><span class="co">## 1:        ca 2020-06-01 2020-06-02    0.000000</span></span>
<span><span class="co">## 2:        ca 2020-06-01 2020-06-06    2.140116</span></span>
<span><span class="co">## 3:        ca 2020-06-01 2020-06-08    2.140379</span></span>
<span><span class="co">## 4:        ca 2020-06-01 2020-06-09    2.114430</span></span>
<span><span class="co">## 5:        ca 2020-06-01 2020-06-10    2.133677</span></span>
<span><span class="co">## 6:        ca 2020-06-01 2020-06-11    2.197207</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">##    geo_value time_value    version percent_cli</span></span>
<span><span class="co">## 1:        ca 2020-06-01 2020-06-02    0.000000</span></span>
<span><span class="co">## 2:        ca 2020-06-01 2020-06-06    2.140116</span></span>
<span><span class="co">## 3:        ca 2020-06-01 2020-06-08    2.140379</span></span>
<span><span class="co">## 4:        ca 2020-06-01 2020-06-09    2.114430</span></span>
<span><span class="co">## 5:        ca 2020-06-01 2020-06-10    2.133677</span></span>
<span><span class="co">## 6:        ca 2020-06-01 2020-06-11    2.197207</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">percent_cli</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">original_value</span></span></code></pre></div>
<p>To make a copy, we can use the <code>clone()</code> method for an R6
class, as in <code>y &lt;- x$clone()</code>. You can read more about
reference semantics in Hadley Wickham’s <a href="https://adv-r.hadley.nz/r6.html#r6-semantics" class="external-link">Advanced R</a>
book.</p>
</div>
<div class="section level2">
<h2 id="some-details-on-metadata">Some details on metadata<a class="anchor" aria-label="anchor" href="#some-details-on-metadata"></a>
</h2>
<p>The following pieces of metadata are included as fields in an
<code>epi_archive</code> object:</p>
<ul>
<li>
<code>geo_type</code>: the type for the geo values.</li>
<li>
<code>time_type</code>: the type for the time values.</li>
<li>
<code>additional_metadata</code>: list of additional metadata for
the data archive.</li>
</ul>
<p>Metadata for an <code>epi_archive</code> object <code>x</code> can be
accessed (and altered) directly, as in <code>x$geo_type</code> or
<code>x$time_type</code>, etc. Just like <code><a href="../reference/as_epi_df.html">as_epi_df()</a></code>, the
function <code><a href="../reference/as_epi_archive.html">as_epi_archive()</a></code> attempts to guess metadata fields
when an <code>epi_archive</code> object is instantiated, if they are not
explicitly specified in the function call (as it did in the case
above).</p>
</div>
<div class="section level2">
<h2 id="producing-snapshots-in-epi_df-form">Producing snapshots in <code>epi_df</code> form<a class="anchor" aria-label="anchor" href="#producing-snapshots-in-epi_df-form"></a>
</h2>
<p>A key method of an <code>epi_archive</code> class is
<code>as_of()</code>, which generates a snapshot of the archive in
<code>epi_df</code> format. This represents the most up-to-date values
of the signal variables as of a given version. This can be accessed via
<code>x$as_of()</code> for an <code>epi_archive</code> object
<code>x</code>, but the package also provides a simple wrapper function
<code><a href="../reference/epix_as_of.html">epix_as_of()</a></code> since this is likely a more familiar interface
for users not familiar with R6 (or object-oriented programming).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_snapshot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">x</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-06-01"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x_snapshot</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "epi_df"     "tbl_df"     "tbl"        "data.frame"</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x_snapshot</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 6 x 3 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2021-06-01</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">##   geo_value time_value percent_cli</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> ca        2020-06-01        2.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> ca        2020-06-02        2.57</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> ca        2020-06-03        2.48</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> ca        2020-06-04        2.41</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> ca        2020-06-05        2.57</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> ca        2020-06-06        2.63</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x_snapshot</span><span class="op">$</span><span class="va">time_value</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "2021-05-31"</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">x_snapshot</span><span class="op">)</span><span class="op">$</span><span class="va">metadata</span><span class="op">$</span><span class="va">as_of</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "2021-06-01"</span></span></code></pre>
<p>We can see that the max time value in the <code>epi_df</code> object
<code>x_snapshot</code> that was generated from the archive is May 29,
2021, even though the specified version date was June 1, 2021. From this
we can infer that the doctor’s visits signal was 2 days latent on June
1. Also, we can see that the metadata in the <code>epi_df</code> object
has the version date recorded in the <code>as_of</code> field.</p>
<p>By default, using the maximum of the <code>version</code> column in
the underlying data table in an <code>epi_archive</code> object itself
generates a snapshot of the latest values of signal variables in the
entire archive. The <code><a href="../reference/epix_as_of.html">epix_as_of()</a></code> function issues a warning
in this case, since updates to the current version may still come in at
a later point in time, due to various reasons, such as synchronization
issues.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">x</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Getting data as of some "clobberable" version that might be hotfixed,</span></span>
<span><span class="co">## synced, or otherwise replaced later with different data using the same version</span></span>
<span><span class="co">## tag.  Thus, the snapshot that we produce here might not be reproducible later.</span></span>
<span><span class="co">## See `?epi_archive` for more info and `?epix_as_of` on how to muffle.</span></span></code></pre>
<p>Below, we pull several snapshots from the archive, spaced one month
apart. We overlay the corresponding signal curves as colored lines, with
the version dates marked by dotted vertical lines, and draw the latest
curve in black (from the latest snapshot <code>x_latest</code> that the
archive can provide).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">self_max</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span></span>
<span><span class="va">versions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-01"</span><span class="op">)</span>, <span class="va">self_max</span> <span class="op">-</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span><span class="va">snapshots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="va">versions</span>, <span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">x</span>, max_version <span class="op">=</span> <span class="va">v</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">v</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">x_latest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>version <span class="op">=</span> <span class="va">self_max</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>latest <span class="op">=</span> <span class="va">version</span> <span class="op">==</span> <span class="va">self_max</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">snapshots</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">latest</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">version</span><span class="op">)</span>, xintercept <span class="op">=</span> <span class="va">version</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"% of doctor's visits with CLI"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">snapshots</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">latest</span><span class="op">)</span>,</span>
<span>               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">percent_cli</span><span class="op">)</span>, </span>
<span>            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="archive_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>We can see some interesting and highly nontrivial revision behavior:
at some points in time the provisional data snapshots grossly
underestimate the latest curve (look in particular at Florida close to
the end of 2021), and at others they overestimate it (both states
towards the beginning of 2021), though not quite as dramatically.
Modeling the revision process, which is often called <em>backfill
modeling</em>, is an important statistical problem in it of itself.</p>
<!-- todo: refer to some project/code? perhaps we should think about writing a
 function in `epiprocess` or even a separate package? -->
</div>
<div class="section level2">
<h2 id="merging-epi_archive-objects">Merging <code>epi_archive</code> objects<a class="anchor" aria-label="anchor" href="#merging-epi_archive-objects"></a>
</h2>
<p>Now we demonstrate how to merge two <code>epi_archive</code> objects
together, e.g., so that grabbing data from multiple sources as of a
particular version can be performed with a single <code>as_of</code>
call. The <code>epi_archive</code> class provides a method
<code><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge()</a></code> precisely for this purpose. The wrapper function is
called <code><a href="../reference/epix_merge.html">epix_merge()</a></code>; this wrapper avoids mutating its
inputs, while <code>x$merge</code> will mutate <code>x</code>. Below we
merge the working <code>epi_archive</code> of versioned percentage CLI
from outpatient visits to another one of versioned COVID-19 case
reporting data, which we fetch the from the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast.html/" class="external-link">COVIDcast
API</a>, on the rate scale (counts per 100,000 people in the
population).</p>
<p>When merging archives, unless the archives have identical data
release patterns, <code>NA</code>s can be introduced in the non-key
variables for a few reasons: - to represent the “value” of an
observation before its initial release (when we need to pair it with
additional observations from the other archive that have been released)
- to represent the “value” of an observation that has no recorded
versions at all (in the same sort of situation) - if requested via
<code>sync="na"</code>, to represent potential update data that we do
not yet have access to (e.g., due to encountering issues while
attempting to download the currently available version data for one of
the archives, but not the other).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_7dav_incidence_prop"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span>,</span>
<span>  issues <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20211201</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, version <span class="op">=</span> <span class="va">issue</span>, case_rate_7d_av <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/as_epi_archive.html">as_epi_archive</a></span><span class="op">(</span>compactify<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">$</span><span class="fu">merge</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_archive` object, with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## * min time value = 2020-06-01</span></span>
<span><span class="co">## * max time value = 2021-11-30</span></span>
<span><span class="co">## * first version with update = 2020-06-02</span></span>
<span><span class="co">## * last version with update = 2021-12-01</span></span>
<span><span class="co">## * clobberable versions start = 2021-12-01</span></span>
<span><span class="co">## * versions end   = 2021-12-01</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Data archive (stored in DT field): 129638 x 5</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Columns in DT: geo_value, time_value, version, percent_cli and 1 more columns</span></span>
<span><span class="co">## ----------</span></span>
<span><span class="co">## Public methods: initialize, print, as_of, fill_through_version, merge, slide, clone</span></span>
<span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">##    geo_value time_value    version percent_cli case_rate_7d_av</span></span>
<span><span class="co">## 1:        ca 2020-06-01 2020-06-02          NA        6.628329</span></span>
<span><span class="co">## 2:        ca 2020-06-01 2020-06-06    2.140116        6.628329</span></span>
<span><span class="co">## 3:        ca 2020-06-01 2020-06-07    2.140116        6.628329</span></span>
<span><span class="co">## 4:        ca 2020-06-01 2020-06-08    2.140379        6.628329</span></span>
<span><span class="co">## 5:        ca 2020-06-01 2020-06-09    2.114430        6.628329</span></span>
<span><span class="co">## 6:        ca 2020-06-01 2020-06-10    2.133677        6.628329</span></span></code></pre>
<p>Importantly, see that <code>x$merge</code> mutated <code>x</code> to
hold the result of the merge. We could also have used
<code>xy = epix_merge(x,y)</code> to avoid mutating <code>x</code>. See
the documentation for either for more detailed descriptions of what
mutation, pointer aliasing, and pointer reseating is possible.</p>
</div>
<div class="section level2">
<h2 id="sliding-version-aware-computations">Sliding version-aware computations<a class="anchor" aria-label="anchor" href="#sliding-version-aware-computations"></a>
</h2>
<p>Lastly, we demonstrate another key method of the
<code>epi_archive</code> class, which is the <code>slide()</code>
method. It works just like <code><a href="../reference/epi_slide.html">epi_slide()</a></code> does for an
<code>epi_df</code> object, but with one key difference: it performs
version-aware computations. That is, for the computation at any given
reference time t, it only uses <strong>data that would have been
available as of t</strong>. The wrapper function is called
<code><a href="../reference/epix_slide.html">epix_slide()</a></code>; again, this is just for
convenience/familiarity—and its interface is purposely designed mirror
that of <code><a href="../reference/epi_slide.html">epi_slide()</a></code> for <code>epi_df</code> objects.</p>
<p>For the demonstration, we’ll revisit the forecasting example from the
<a href="https://cmu-delphi.github.io/epiprocess/articles/slide.html">slide
vignette</a>, and now we’ll build a forecaster that uses
properly-versioned data (that would have been available in real-time) to
forecast future COVID-19 case rates from current and past COVID-19 case
rates, as well as current and past values of the outpatient CLI signal
from medical claims. We’ll extend the <code>prob_ar()</code> function
from the slide vignette to accomodate exogenous variables in the
autoregressive model, which is often referred to as an ARX model.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_arx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">min_train_window</span> <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                     <span class="va">lower_level</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="va">upper_level</span> <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">symmetrize</span> <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                     <span class="va">intercept</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">nonneg</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>   </span>
<span>  <span class="co"># Return NA if insufficient training data</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">min_train_window</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>point <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Useful transformations</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html" class="external-link">missing</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw">else</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span><span class="op">)</span> <span class="va">lags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span></span>
<span>  <span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">lags</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Build features and response for the AR model, and then fit it</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>    <span class="va">data.frame</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span> <span class="co"># Below we loop through and build the lagged features</span></span>
<span>      <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span> </span>
<span>        <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">lags</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, n <span class="op">=</span> <span class="va">j</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span>,</span>
<span>      recursive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">intercept</span><span class="op">)</span> <span class="va">dat</span><span class="op">$</span><span class="va">x0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead</a></span><span class="op">(</span><span class="va">y</span>, n <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span> </span>
<span>  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Use LOCF to fill NAs in the latest feature values, make a prediction</span></span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/nafill.html" class="external-link">setnafill</a></span><span class="op">(</span><span class="va">dat</span>, type <span class="op">=</span> <span class="st">"locf"</span><span class="op">)</span></span>
<span>  <span class="va">point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">obj</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute a band </span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">symmetrize</span>, <span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># Should the residuals be symmetrized?</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">s</span> <span class="op">*</span> <span class="va">r</span><span class="op">)</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lower_level</span>, <span class="va">upper_level</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Clip at zero if we need to, then return</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">nonneg</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="va">point</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">point</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>    <span class="va">lower</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lower</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>    <span class="va">upper</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">upper</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>point <span class="op">=</span> <span class="va">point</span>, lower <span class="op">=</span> <span class="va">lower</span>, upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next we slide this forecaster over the working
<code>epi_archive</code> object, in order to forecast COVID-19 case
rates 7 days into the future.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_time_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-08-01"</span><span class="op">)</span>, </span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, </span>
<span>                      by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span><span class="op">(</span><span class="va">x</span>, fc <span class="op">=</span> <span class="fu">prob_arx</span><span class="op">(</span>x <span class="op">=</span> <span class="va">percent_cli</span>, y <span class="op">=</span> <span class="va">case_rate_7d_av</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">120</span>, </span>
<span>                ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span>, group_by <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">z</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 5 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2020-08-01</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">##    geo_value time_value fc_point fc_lower fc_upper</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-08-01    21.0     19.1     23.0 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> fl        2020-08-01    44.5     38.9     50.0 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ny        2020-08-01     3.10     2.89     3.31</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> tx        2020-08-01    35.5     33.6     37.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-09-01    22.9     20.1     25.8 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> fl        2020-09-01    15.5     10.5     20.6 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ny        2020-09-01     3.16     2.93     3.39</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> tx        2020-09-01    17.5     14.3     20.7 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2020-10-01    12.8      9.21    16.5 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> fl        2020-10-01    14.7      8.72    20.6</span></span></code></pre>
<p>We get back a tibble <code>z</code> with the grouping variables (here
geo value), the time values, and three columns <code>fc_point</code>,
<code>fc_lower</code>, and <code>fc_upper</code> produced by the slide
computation that correspond to the point forecast, and the lower and
upper endpoints of the 95% prediction band, respectively. (If instead we
had set <code>as_list_col = TRUE</code> in the call to
<code><a href="../reference/epix_slide.html">epix_slide()</a></code>, then we would have gotten a list column
<code>fc</code>, where each element of <code>fc</code> is a data frame
with named columns <code>point</code>, <code>lower</code>, and
<code>upper</code>.)</p>
<p>On the whole, <code><a href="../reference/epix_slide.html">epix_slide()</a></code> works similarly to
<code><a href="../reference/epix_slide.html">epix_slide()</a></code>, though there are a few notable differences,
even apart from the version-aware aspect. You can read the documentation
for <code><a href="../reference/epix_slide.html">epix_slide()</a></code> for details.</p>
<p>We finish off by comparing version-aware and -unaware forecasts at
various points in time and forecast horizons. The former comes from
applying <code><a href="../reference/epix_slide.html">epix_slide()</a></code> to the <code>epi_archive</code>
object <code>x</code>, and the latter from applying
<code><a href="../reference/epi_slide.html">epi_slide()</a></code> to the latest snapshot of the data
<code>x_latest</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_latest</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/epix_as_of.html">epix_as_of</a></span><span class="op">(</span><span class="va">x</span>, max_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">DT</span><span class="op">$</span><span class="va">version</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simple function to produce forecasts k weeks ahead</span></span>
<span><span class="va">k_week_ahead</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">as_of</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">as_of</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/epix_slide.html">epix_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_arx</span><span class="op">(</span><span class="va">percent_cli</span>, <span class="va">case_rate_7d_av</span>, ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">120</span>,</span>
<span>                 ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span>, group_by <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">ahead</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">x_latest</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_arx</span><span class="op">(</span><span class="va">percent_cli</span>, <span class="va">case_rate_7d_av</span>, ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">120</span>,</span>
<span>                ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">ahead</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate the forecasts, and bind them together</span></span>
<span><span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">7</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">14</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">21</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">28</span>, as_of <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">7</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">14</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">21</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">28</span>, as_of <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot them, on top of latest COVID-19 case rates </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">fc</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, group <span class="op">=</span> <span class="va">time_value</span>, fill <span class="op">=</span> <span class="va">as_of</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">fc_lower</span>, ymax <span class="op">=</span> <span class="va">fc_upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_latest</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">case_rate_7d_av</span><span class="op">)</span>, </span>
<span>               inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_point</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">fc_point</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">as_of</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 case rates"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="archive_files/figure-html/unnamed-chunk-15-1.png" width="864"></p>
<p>Each row displays the forecasts for a different location (CA, FL, NY,
and TX), and each column corresponds to whether properly-versioned data
is used (<code>FALSE</code> means no, and <code>TRUE</code> means yes).
We can see that the properly-versioned forecaster is, at some points in
time, more problematic; for example, it massively overpredicts the peak
in both locations in winter wave of 2020. However, performance is pretty
poor across the board here, whether or not properly-versioned data is
used. Similar to what we saw in the <a href="https://cmu-delphi.github.io/epiprocess/articles/archive.html">slide
vignette</a>, the ARX forecasts can too volatile, overconfident, or
both.</p>
<p>Some of the volatility can be attenuated here by training an ARX
model jointly over locations; the <a href="https://cmu-delphi.github.io/epiprocess/articles/advanced.html">advanced
sliding vignette</a> gives a demonstration of how to do this. But
really, the <a href="https://cmu-delphi.github.io/epipredict/" class="external-link"><code>epipredict</code></a>
package, which builds off the data structures and functionality in the
current package, is the place to look for more robust forecasting
methodology. The forecasters that appear in the vignettes in the current
package are only meant to demo the slide functionality with some of the
most basic forecasting methodology possible.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This document contains a dataset that is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data
Repository by the Center for Systems Science and Engineering (CSSE) at
Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished
in the COVIDcast Epidata API</a>. This data set is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
<p>The <code>percent_cli</code> data is a modified part of the <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html" class="external-link">COVIDcast
Epidata API Doctor Visits data</a>. This dataset is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a>. Copyright Delphi Research
Group at Carnegie Mellon University 2020.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Logan Brooks, Daniel McDonald, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
