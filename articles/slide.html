<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epiprocess">
<title>Slide a computation over signal values • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Slide a computation over signal values">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5.0.9999</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/epiprocess.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/slide.html">Slide a computation over signal values</a>
    <a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    <a class="dropdown-item" href="../articles/correlation.html">Correlate signals over space and time</a>
    <a class="dropdown-item" href="../articles/aggregation.html">Aggregate signals over space and time</a>
    <a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a>
    <a class="dropdown-item" href="../articles/archive.html">Work with archive objects and data revisions</a>
    <a class="dropdown-item" href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
    <a class="dropdown-item" href="../articles/compactify.html">Compactify to remove redundant archive data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/tree/main/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Slide a computation over signal values</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/slide.Rmd" class="external-link"><code>vignettes/slide.Rmd</code></a></small>
      <div class="d-none name"><code>slide.Rmd</code></div>
    </div>

    
    
<p>A central tool in the <code>epiprocess</code> package is
<code><a href="../reference/epi_slide.html">epi_slide()</a></code>, which is based on the powerful functionality
provided in the <a href="https://cran.r-project.org/web/packages/slider" class="external-link"><code>slider</code></a>
package. In <code>epiprocess</code>, to “slide” means to apply a
computation—represented as a function or formula—over a running window
of <code>n</code> time steps. Suitable groupings can always be achieved
by a preliminary call to <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code>.</p>
<p>By default, the meaning of one time step is inferred from the
<code>time_value</code> column of the <code>epi_df</code> object under
consideration, based on the way this column understands addition and
subtraction. For example, if the time values are coded as
<code>Date</code> objects, then one time step is one day, since
<code>as.Date("2022-01-01") + 1</code> equals
<code>as.Date("2022-01-02")</code>. Alternatively, the time step can be
specified manually in the call to <code><a href="../reference/epi_slide.html">epi_slide()</a></code>; you can read
the documentation for more details. Furthermore, the alignment of the
running window used in <code><a href="../reference/epi_slide.html">epi_slide()</a></code> can be “right”,
“center”, or “left”; the default is “right”, and is what we use in this
vignette.</p>
<p>As in getting started guide, we’ll fetch daily reported COVID-19
cases from CA, FL, NY, and TX (note: here we’re using new, not
cumulative cases) using the <a href="https://github.com/cmu-delphi/epidatr" class="external-link"><code>epidatr</code></a>
package, and then convert this to <code>epi_df</code> format.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epidatr" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<p>The data is fetched with the following query:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200301</span>, <span class="fl">20211231</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"ca,fl,ny,tx"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, cases <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The data has 2,684 rows and 3 columns.</p>
<div class="section level2">
<h2 id="slide-with-a-formula">Slide with a formula<a class="anchor" aria-label="anchor" href="#slide-with-a-formula"></a>
</h2>
<p>We first demonstrate how to apply a 7-day trailing average to the
daily cases in order to smooth the signal, by passing in a formula for
the first argument of <code><a href="../reference/epi_slide.html">epi_slide()</a></code>. To do this computation
per state, we first call <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 4 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-23 20:17:07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [1]</span></span></span>
<span><span class="co">##    geo_value time_value cases slide_value</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-03-01     6        6   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ca        2020-03-02     4        5   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ca        2020-03-03     6        5.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ca        2020-03-04    11        6.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-03-05    10        7.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ca        2020-03-06    18        9.17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ca        2020-03-07    26       11.6 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> ca        2020-03-08    19       13.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2020-03-09    23       16.1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ca        2020-03-10    22       18.4</span></span></code></pre>
<p>The formula specified has access to all columns present in the
original <code>epi_df</code> object (and must refer to them with the
prefix <code>.x$</code>). As we can see, the function
<code><a href="../reference/epi_slide.html">epi_slide()</a></code> returns an <code>epi_df</code> object with a
new column appended that contains the results (from sliding), named
<code>slide_value</code> as the default. We can of course change this
post hoc, or we can instead specify a new name up front using the
<code>new_col_name</code> argument:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span><span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span>, new_col_name <span class="op">=</span> <span class="st">"cases_7dav"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 4 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-23 20:17:07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [1]</span></span></span>
<span><span class="co">##    geo_value time_value cases cases_7dav</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-03-01     6       6   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ca        2020-03-02     4       5   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ca        2020-03-03     6       5.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ca        2020-03-04    11       6.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-03-05    10       7.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ca        2020-03-06    18       9.17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ca        2020-03-07    26      11.6 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> ca        2020-03-08    19      13.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2020-03-09    23      16.1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ca        2020-03-10    22      18.4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="slide-with-a-function">Slide with a function<a class="anchor" aria-label="anchor" href="#slide-with-a-function"></a>
</h2>
<p>We can also pass a function for the first argument in
<code><a href="../reference/epi_slide.html">epi_slide()</a></code>. In this case, the passed function must have
the following argument structure: <code>x</code>, a data frame with the
same column names as the original object; followed by any number of
named arguments; and ending with <code>...</code> to capture additional
arguments. Recreating the last example of a 7-day trailing average:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">cases</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span>, new_col_name <span class="op">=</span> <span class="st">"cases_7dav"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 4 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-23 20:17:07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [1]</span></span></span>
<span><span class="co">##    geo_value time_value cases cases_7dav</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-03-01     6       6   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ca        2020-03-02     4       5   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ca        2020-03-03     6       5.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ca        2020-03-04    11       6.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-03-05    10       7.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ca        2020-03-06    18       9.17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ca        2020-03-07    26      11.6 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> ca        2020-03-08    19      13.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2020-03-09    23      16.1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ca        2020-03-10    22      18.4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="slide-the-tidy-way">Slide the tidy way<a class="anchor" aria-label="anchor" href="#slide-the-tidy-way"></a>
</h2>
<p>Perhaps the most convenient way to setup a computation in
<code><a href="../reference/epi_slide.html">epi_slide()</a></code> is to pass in an expression for tidy
evaluation. In this case, we can simply define the name of the new
column directly as part of the expression, setting it equal to a
computation in which we can access any columns of <code>x</code> by
name, just as we would in a call to <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code>, or any
of the <code>dplyr</code> verbs. For example:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>cases_7dav <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cases</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 4 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-23 20:17:07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [1]</span></span></span>
<span><span class="co">##    geo_value time_value cases cases_7dav</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-03-01     6       6   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ca        2020-03-02     4       5   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ca        2020-03-03     6       5.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ca        2020-03-04    11       6.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-03-05    10       7.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ca        2020-03-06    18       9.17</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ca        2020-03-07    26      11.6 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> ca        2020-03-08    19      13.4 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2020-03-09    23      16.1 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ca        2020-03-10    22      18.4</span></span></code></pre>
<p>As a simple sanity check, we visualize the 7-day trailing averages
computed on top of the original counts:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases</span>, fill <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases_7dav</span>, col <span class="op">=</span> <span class="va">geo_value</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">geo_value</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 cases"</span><span class="op">)</span></span></code></pre></div>
<p><img src="slide_files/figure-html/unnamed-chunk-8-1.png" width="864"></p>
<p>As we can see from the top right panel, it looks like Texas moved to
weekly reporting of COVID-19 cases in summer of 2021.</p>
</div>
<div class="section level2">
<h2 id="running-a-local-forecaster">Running a local forecaster<a class="anchor" aria-label="anchor" href="#running-a-local-forecaster"></a>
</h2>
<p>As a more complex example, we create a forecaster based on a local
(in time) autoregression or AR model. AR models can be fit in numerous
ways (using base R functions and various packages), but here we define
it “by hand” both because it provides a more advanced example of sliding
a function over an <code>epi_df</code> object, and because it allows us
to be a bit more flexible in defining a <em>probabilistic</em>
forecaster: one that outputs not just a point prediction, but a notion
of uncertainty around this. In particular, our forecaster will output a
point prediction along with an 90% uncertainty band, represented by a
predictive quantiles at the 5% and 95% levels (lower and upper endpoints
of the uncertainty band).</p>
<p>The function defined below, <code>prob_ar()</code>, is our
probabilistic AR forecaster. The <code>lags</code>argument indicates
which lags to use in the model, and <code>ahead</code> indicates how far
ahead in the future to make forecasts (both are encoded in terms of the
units of the <code>time_value</code> column; so, days, in the working
<code>epi_df</code> being considered in this vignette).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prob_ar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span>, <span class="va">lags</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span>, <span class="fl">14</span><span class="op">)</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">min_train_window</span> <span class="op">=</span> <span class="fl">20</span>, </span>
<span>                    <span class="va">lower_level</span> <span class="op">=</span> <span class="fl">0.05</span>, <span class="va">upper_level</span> <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">symmetrize</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    <span class="va">intercept</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">nonneg</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span>   </span>
<span>  <span class="co"># Return NA if insufficient training data</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">min_train_window</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lags</span><span class="op">)</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>point <span class="op">=</span> <span class="cn">NA</span>, lower <span class="op">=</span> <span class="cn">NA</span>, upper <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Build features and response for the AR model</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>    <span class="va">data.frame</span>, </span>
<span>    <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">lags</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">y</span>, n <span class="op">=</span> <span class="va">j</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">intercept</span><span class="op">)</span> <span class="va">dat</span><span class="op">$</span><span class="va">x0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">dat</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead</a></span><span class="op">(</span><span class="va">y</span>, n <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="co"># Now fit the AR model and make a prediction</span></span>
<span>  <span class="va">obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span>  <span class="va">point</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">obj</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute a band </span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">obj</span><span class="op">)</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">symmetrize</span>, <span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co"># Should the residuals be symmetrized?</span></span>
<span>  <span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">s</span> <span class="op">*</span> <span class="va">r</span><span class="op">)</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">lower_level</span>, <span class="va">upper_level</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">lower</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">upper</span> <span class="op">&lt;-</span> <span class="va">point</span> <span class="op">+</span> <span class="va">q</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Clip at zero if we need to, then return</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">nonneg</span><span class="op">)</span> <span class="op">{</span> </span>
<span>    <span class="va">point</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">point</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>    <span class="va">lower</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">lower</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>    <span class="va">upper</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">upper</span>, <span class="fl">0</span><span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>point <span class="op">=</span> <span class="va">point</span>, lower <span class="op">=</span> <span class="va">lower</span>, upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We go ahead and slide this AR forecaster over the working
<code>epi_df</code> of COVID-19 cases. Note that we actually model the
<code>cases_7dav</code> column, to operate on the scale of smoothed
COVID-19 cases. This is clearly equivalent, up to a constant, to
modeling weekly sums of COVID-19 cases.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fc_time_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2020-06-01"</span><span class="op">)</span>, </span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2021-12-01"</span><span class="op">)</span>, </span>
<span>                      by <span class="op">=</span> <span class="st">"1 months"</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_ar</span><span class="op">(</span><span class="va">cases_7dav</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">120</span>, </span>
<span>            ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 10 x 7 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-23 20:17:07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 7</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [1]</span></span></span>
<span><span class="co">##    geo_value time_value cases cases_7dav fc_point fc_lower fc_upper</span></span>
<span><span class="co">##  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> ca        2020-06-01  <span style="text-decoration: underline;">2</span>439      <span style="text-decoration: underline;">2</span>655.    <span style="text-decoration: underline;">2</span>959.    <span style="text-decoration: underline;">2</span>513.    <span style="text-decoration: underline;">3</span>404.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> ca        2020-07-01  <span style="text-decoration: underline;">7</span>347      <span style="text-decoration: underline;">6</span>722.    <span style="text-decoration: underline;">8</span>051.    <span style="text-decoration: underline;">7</span>394.    <span style="text-decoration: underline;">8</span>708.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> ca        2020-08-01  <span style="text-decoration: underline;">8</span>614      <span style="text-decoration: underline;">8</span>283.    <span style="text-decoration: underline;">7</span>144.    <span style="text-decoration: underline;">5</span>971.    <span style="text-decoration: underline;">8</span>317.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ca        2020-09-01  <span style="text-decoration: underline;">4</span>247      <span style="text-decoration: underline;">4</span>704.    <span style="text-decoration: underline;">3</span>989.    <span style="text-decoration: underline;">1</span>896.    <span style="text-decoration: underline;">6</span>082.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> ca        2020-10-01  <span style="text-decoration: underline;">3</span>505      <span style="text-decoration: underline;">3</span>361.    <span style="text-decoration: underline;">3</span>238.    <span style="text-decoration: underline;">1</span>283.    <span style="text-decoration: underline;">5</span>194.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ca        2020-11-01  <span style="text-decoration: underline;">4</span>211      <span style="text-decoration: underline;">4</span>442.    <span style="text-decoration: underline;">3</span>760.    <span style="text-decoration: underline;">2</span>083.    <span style="text-decoration: underline;">5</span>438.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> ca        2020-12-01 <span style="text-decoration: underline;">23</span>637     <span style="text-decoration: underline;">15</span>698.   <span style="text-decoration: underline;">18</span>396.   <span style="text-decoration: underline;">16</span>629.   <span style="text-decoration: underline;">20</span>162.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> ca        2021-01-01 <span style="text-decoration: underline;">50</span>251     <span style="text-decoration: underline;">41</span>114.   <span style="text-decoration: underline;">49</span>691.   <span style="text-decoration: underline;">41</span>828.   <span style="text-decoration: underline;">57</span>554.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ca        2021-02-01 <span style="text-decoration: underline;">13</span>112     <span style="text-decoration: underline;">17</span>961    <span style="text-decoration: underline;">14</span>528.    <span style="text-decoration: underline;">4</span>442.   <span style="text-decoration: underline;">24</span>615.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> ca        2021-03-01  <span style="text-decoration: underline;">3</span>030      <span style="text-decoration: underline;">5</span>212.    <span style="text-decoration: underline;">4</span>365.       0    <span style="text-decoration: underline;">14</span>444.</span></span></code></pre>
<p>Note that here we have utilized an argument
<code>ref_time_values</code> to perform the sliding computation (here,
compute a forecast) at a specific subset of reference time values. We
get out three columns <code>fc_point</code>, <code>fc_lower</code>, and
<code>fc_upper</code> that correspond to the point forecast, and the
lower and upper endpoints of the 95% prediction band, respectively. (If
instead we had set <code>as_list_col = TRUE</code> in the call to
<code><a href="../reference/epi_slide.html">epi_slide()</a></code>, then we would have gotten a list column
<code>fc</code>, where each element of <code>fc</code> is a data frame
with named columns <code>point</code>, <code>lower</code>, and
<code>upper</code>.)</p>
<p>To finish off, we plot the forecasts at some times (spaced out by a
few months) over the last year, at multiple horizons: 7, 14, 21, and 28
days ahead. To do so, we encapsulate the process of generating forecasts
into a simple function, so that we can call it a few times.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note the use of all_rows = TRUE (keeps all original rows in the output)</span></span>
<span><span class="va">k_week_ahead</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">ahead</span> <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/epi_slide.html">epi_slide</a></span><span class="op">(</span>fc <span class="op">=</span> <span class="fu">prob_ar</span><span class="op">(</span><span class="va">cases_7dav</span>, ahead <span class="op">=</span> <span class="va">ahead</span><span class="op">)</span>, n <span class="op">=</span> <span class="fl">120</span>,</span>
<span>              ref_time_values <span class="op">=</span> <span class="va">fc_time_values</span>, all_rows <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target_date <span class="op">=</span> <span class="va">time_value</span> <span class="op">+</span> <span class="va">ahead</span><span class="op">)</span> </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># First generate the forecasts, and bind them together</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>,</span>
<span>               <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>,</span>
<span>               <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">21</span><span class="op">)</span>,</span>
<span>               <span class="fu">k_week_ahead</span><span class="op">(</span><span class="va">x</span>, ahead <span class="op">=</span> <span class="fl">28</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now plot them, on top of actual COVID-19 case counts </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cases_7dav</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"gray50"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, ymin <span class="op">=</span> <span class="va">fc_lower</span>, ymax <span class="op">=</span> <span class="va">fc_upper</span>,</span>
<span>                  group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fl">6</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, y <span class="op">=</span> <span class="va">fc_point</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">target_date</span>, y <span class="op">=</span> <span class="va">fc_point</span>, group <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span>, </span>
<span>             size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">fc_time_values</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, </span>
<span>             linetype <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 cases"</span><span class="op">)</span></span></code></pre></div>
<p><img src="slide_files/figure-html/unnamed-chunk-11-1.png" width="864"></p>
<p>Two points are worth making. First, the AR model’s performance here
is pretty spotty. At various points in time, we can see that its
forecasts are volatile (its point predictions are all over the place),
or overconfident (its bands are too narrow), or both at the same time.
This is only meant as a simple demo and not entirely unexpected given
the way the AR model is set up. The <a href="https://cmu-delphi.github.io/epipredict" class="external-link"><code>epipredict</code></a>
package, which is a companion package to <code>epiprocess</code>, offers
a suite of predictive modeling tools that can improve on some of the
shortcomings of the above simple AR model.</p>
<p>Second, the AR forecaster here is using finalized data, meaning, it
uses the latest versions of signal values (reported COVID-19 cases)
available, for both training models and making predictions historically.
However, this is not reflective of the provisional nature of the data
that it must cope with in a true forecast task. Training and making
predictions on finalized data can lead to an overly optimistic sense of
accuracy; see, for example, <a href="https://www.pnas.org/content/118/51/e2111453118/" class="external-link">McDonald et al.
(2021)</a>, and references therein. Fortunately, the
<code>epiprocess</code> package provides a data structure called
<code>epi_archive</code> that can be used to store all data revisions,
and furthermore, an <code>epi_archive</code> object knows how to slide
computations in the correct version-aware sense (for the computation at
each reference time <span class="math inline">\(t\)</span>, it uses only
data that would have been available as of <span class="math inline">\(t\)</span>). We will revisit this example in the
<a href="https://cmu-delphi.github.io/epiprocess/articles/archive.html">archive
vignette</a>.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This document contains a dataset that is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data
Repository by the Center for Systems Science and Engineering (CSSE) at
Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished
in the COVIDcast Epidata API</a>. This data set is licensed under the
terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons
Attribution 4.0 International license</a> by the Johns Hopkins
University on behalf of its Center for Systems Science in Engineering.
Copyright Johns Hopkins University 2020.</p>
<p><a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">From
the COVIDcast Epidata API</a>: These signals are taken directly from the
JHU CSSE <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19
GitHub repository</a> without changes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Logan Brooks, Daniel McDonald, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
