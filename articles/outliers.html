<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="epiprocess">
<title>Detect and correct outliers in signals • epiprocess</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Detect and correct outliers in signals">
<meta property="og:description" content="epiprocess">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">epiprocess</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/epiprocess.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/slide.html">Slide a computation over signal values</a>
    <a class="dropdown-item" href="../articles/growth_rate.html">Estimate growth rates in signals</a>
    <a class="dropdown-item" href="../articles/correlation.html">Correlate signals over space and time</a>
    <a class="dropdown-item" href="../articles/aggregation.html">Aggregate signals over space and time</a>
    <a class="dropdown-item" href="../articles/outliers.html">Detect and correct outliers in signals</a>
    <a class="dropdown-item" href="../articles/archive.html">Work with archive objects and data revisions</a>
    <a class="dropdown-item" href="../articles/advanced.html">Advanced sliding with nonstandard outputs</a>
    <a class="dropdown-item" href="../articles/compactify.html">Compactify to remove redundant archive data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cmu-delphi/epiprocess/tree/main/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="outliers_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Detect and correct outliers in signals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cmu-delphi/epiprocess/blob/main/vignettes/outliers.Rmd" class="external-link"><code>vignettes/outliers.Rmd</code></a></small>
      <div class="d-none name"><code>outliers.Rmd</code></div>
    </div>

    
    
<p>This vignette describes functionality for detecting and correcting outliers in signals in the <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code> and <code>correct_outlr()</code> functions provided in the <code>epiprocess</code> package. These functions is designed to be modular and extendable, so that you can define your own outlier detection and correction routines and apply them to <code>epi_df</code> objects. We’ll demonstrate this using state-level daily reported COVID-19 case counts from FL and NJ.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cmu-delphi/epidatr" class="external-link">epidatr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cmu-delphi.github.io/epiprocess/">epiprocess</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/covidcast.html" class="external-link">covidcast</a></span><span class="op">(</span></span>
<span>  data_source <span class="op">=</span> <span class="st">"jhu-csse"</span>,</span>
<span>  signals <span class="op">=</span> <span class="st">"confirmed_incidence_num"</span>,</span>
<span>  time_type <span class="op">=</span> <span class="st">"day"</span>,</span>
<span>  geo_type <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  time_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/epirange.html" class="external-link">epirange</a></span><span class="op">(</span><span class="fl">20200601</span>, <span class="fl">20210531</span><span class="op">)</span>,</span>
<span>  geo_values <span class="op">=</span> <span class="st">"fl,nj"</span>,</span>
<span>  as_of <span class="op">=</span> <span class="fl">20211028</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/epidatr/man/fetch_tbl.html" class="external-link">fetch_tbl</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, cases <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/as_epi_df.html">as_epi_df</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The dataset has 730 rows and 3 columns.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
<p>There are multiple outliers in these data that a modeler may want to detect and correct. We’ll discuss those two tasks in turn.</p>
<div class="section level2">
<h2 id="outlier-detection">Outlier detection<a class="anchor" aria-label="anchor" href="#outlier-detection"></a>
</h2>
<p>The <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code> function allows us to run multiple outlier detection methods on a given signal, and then (optionally) combine the results from those methods. Here, we’ll investigate outlier detection results from the following methods.</p>
<ol style="list-style-type: decimal">
<li>Detection based on a rolling median, using <code><a href="../reference/detect_outlr_rm.html">detect_outlr_rm()</a></code>, which computes a rolling median on with a default window size of <code>n</code> time points centered at the time point under consideration, and then computes thresholds based on a multiplier times a rolling IQR computed on the residuals.</li>
<li>Detection based on a seasonal-trend decomposition using LOESS (STL), using <code><a href="../reference/detect_outlr_stl.html">detect_outlr_stl()</a></code>, which is similar to the rolling median method but replaces the rolling median with fitted values from STL.</li>
<li>Detection based on an STL decomposition, but without seasonality term, which amounts to smoothing using LOESS.</li>
</ol>
<p>The outlier detection methods are specified using a <code>tibble</code> that is passed to <code><a href="../reference/detect_outlr.html">detect_outlr()</a></code>, with one row per method, and whose columms specify the outlier detection function, any input arguments (only nondefault values need to be supplied), and an abbreviated name for the method used in tracking results. Abbreviations “rm” and “stl” can be used for the built-in detection functions <code><a href="../reference/detect_outlr_rm.html">detect_outlr_rm()</a></code> and <code><a href="../reference/detect_outlr_stl.html">detect_outlr_stl()</a></code>, respectively.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">detection_methods</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"rm"</span>,</span>
<span>         args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          detection_multiplier <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         abbr <span class="op">=</span> <span class="st">"rm"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"stl"</span>,</span>
<span>         args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          detection_multiplier <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                          seasonal_period <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         abbr <span class="op">=</span> <span class="st">"stl_seasonal"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"stl"</span>,</span>
<span>         args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>detect_negatives <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                          detection_multiplier <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>                          seasonal_period <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         abbr <span class="op">=</span> <span class="st">"stl_nonseasonal"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">detection_methods</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 3</span></span></span>
<span><span class="co">##   method args             abbr           </span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rm     <span style="color: #949494;">&lt;named list [2]&gt;</span> rm             </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> stl    <span style="color: #949494;">&lt;named list [3]&gt;</span> stl_seasonal   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> stl    <span style="color: #949494;">&lt;named list [3]&gt;</span> stl_nonseasonal</span></span></code></pre>
<p>Additionally, we’ll form combined lower and upper thresholds, calculated as the median of the lower and upper thresholds from the methods at each time point. Note that using this combined median threshold is equivalent to using a majority vote across the base methods to determine whether a value is an outlier.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>outlier_info  <span class="op">=</span> <span class="fu"><a href="../reference/detect_outlr.html">detect_outlr</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="va">cases</span>,</span>
<span>    methods <span class="op">=</span> <span class="va">detection_methods</span>,</span>
<span>    combiner <span class="op">=</span> <span class="st">"median"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">outlier_info</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An `epi_df` object, 6 x 15 with metadata:</span></span>
<span><span class="co">## * geo_type  = state</span></span>
<span><span class="co">## * time_type = day</span></span>
<span><span class="co">## * as_of     = 2022-05-21 22:17:14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 15</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [2]</span></span></span>
<span><span class="co">##   geo_value time_value cases rm_lower rm_upper rm_repl…¹ stl_s…² stl_s…³ stl_s…⁴</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> fl        2020-06-01   667    345      <span style="text-decoration: underline;">2</span>195        667      0    <span style="text-decoration: underline;">1</span>537.     667</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> nj        2020-06-01   486     64.4     926.       486    221.    822.     486</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> fl        2020-06-02   617    406.     <span style="text-decoration: underline;">2</span>169.       617      0    <span style="text-decoration: underline;">2</span>212.     617</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> nj        2020-06-02   658    140.      841.       658    245.    963.     658</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> fl        2020-06-03  <span style="text-decoration: underline;">1</span>317    468.     <span style="text-decoration: underline;">2</span>142.      <span style="text-decoration: underline;">1</span>317      0    <span style="text-decoration: underline;">2</span>713.    <span style="text-decoration: underline;">1</span>317</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> nj        2020-06-03   541    216       756        541    227.    873.     541</span></span>
<span><span class="co">## <span style="color: #949494;"># … with 6 more variables: stl_nonseasonal_lower &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   stl_nonseasonal_upper &lt;dbl&gt;, stl_nonseasonal_replacement &lt;dbl&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   combined_lower &lt;dbl&gt;, combined_upper &lt;dbl&gt;, combined_replacement &lt;dbl&gt;, and</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   abbreviated variable names ¹​rm_replacement, ²​stl_seasonal_lower,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ³​stl_seasonal_upper, ⁴​stl_seasonal_replacement</span></span></span></code></pre>
<p>To visualize the results, we first define a convenience function for plotting.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot outlier detection bands and/or points identified as outliers</span></span>
<span><span class="va">plot_outlr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">signal</span>, <span class="va">method_abbr</span>, <span class="va">bands</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">points</span> <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                       <span class="va">facet_vars</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, <span class="va">nrow</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">ncol</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                       <span class="va">scales</span> <span class="op">=</span> <span class="st">"fixed"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Convert outlier detection results to long format </span></span>
<span>  <span class="va">signal</span> <span class="op">&lt;-</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span>  <span class="va">x_long</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>      cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="va">method_abbr</span><span class="op">)</span>,</span>
<span>      names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"method"</span>, <span class="st">".value"</span><span class="op">)</span>,</span>
<span>      names_pattern <span class="op">=</span> <span class="st">"(.+)_(.+)"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Start of plot with observed data</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">signal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If requested, add bands</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">bands</span><span class="op">)</span> </span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_long</span>, </span>
<span>                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span>, </span>
<span>                             color <span class="op">=</span> <span class="va">method</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If requested, add points</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">points</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x_detected</span> <span class="op">&lt;-</span> <span class="va">x_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">signal</span> <span class="op">&lt;</span> <span class="va">lower</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">signal</span> <span class="op">&gt;</span> <span class="va">upper</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x_detected</span>, </span>
<span>                        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span>, y <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">signal</span>, color <span class="op">=</span> <span class="va">method</span>, </span>
<span>                            shape <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># If requested, add faceting</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">facet_vars</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">facet_vars</span>, nrow <span class="op">=</span> <span class="va">nrow</span>, ncol <span class="op">=</span> <span class="va">ncol</span>, scales <span class="op">=</span> <span class="va">scales</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we produce plots for each state at a time, faceting by the detection method.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method_abbr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">detection_methods</span><span class="op">$</span><span class="va">abbr</span>, <span class="st">"combined"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_outlr</span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="st">"fl"</span><span class="op">)</span>, <span class="va">cases</span>, <span class="va">method_abbr</span>,</span>
<span>           facet_vars <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span>, color  <span class="op">=</span> <span class="st">"Method"</span>,</span>
<span>       shape <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-7-1.png" width="864"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_outlr</span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">geo_value</span> <span class="op">==</span> <span class="st">"nj"</span><span class="op">)</span>, <span class="va">cases</span>, <span class="va">method_abbr</span>,</span>
<span>           facet_vars <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span>, color  <span class="op">=</span> <span class="st">"Method"</span>,</span>
<span>       shape <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-7-2.png" width="864"></p>
</div>
<div class="section level2">
<h2 id="outlier-correction">Outlier correction<a class="anchor" aria-label="anchor" href="#outlier-correction"></a>
</h2>
<p>Finally, in order to correct outliers, we can use the posited replacement values returned by each outlier detection method. Below we use the replacement value from the combined method, which is defined by the median of replacement values from the base methods at each time point.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cases_corrected <span class="op">=</span> <span class="va">combined_replacement</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">geo_value</span>, <span class="va">time_value</span>, <span class="va">cases</span>, <span class="va">cases_corrected</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">y</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cases</span> <span class="op">!=</span> <span class="va">cases_corrected</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 22 × 4</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   geo_value [2]</span></span></span>
<span><span class="co">##    geo_value time_value cases cases_corrected</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> fl        2020-07-12 <span style="text-decoration: underline;">15</span>300          <span style="text-decoration: underline;">10</span>181 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> nj        2020-07-19    -<span style="color: #BB0000;">8</span>            320.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> nj        2020-08-13   694            404.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> nj        2020-08-14   619            397.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> nj        2020-08-16    40            366 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> nj        2020-08-22   555            360 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> fl        2020-09-01  <span style="text-decoration: underline;">7</span>569           <span style="text-decoration: underline;">2</span>861.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> nj        2020-10-08  <span style="text-decoration: underline;">1</span>415            873.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> fl        2020-10-10     0           <span style="text-decoration: underline;">2</span>660 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> fl        2020-10-11  <span style="text-decoration: underline;">5</span>570           <span style="text-decoration: underline;">2</span>660 </span></span>
<span><span class="co">## <span style="color: #949494;"># … with 12 more rows</span></span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time_value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cases_corrected</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">geo_value</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>minor_breaks <span class="op">=</span> <span class="st">"month"</span>, date_labels <span class="op">=</span> <span class="st">"%b %y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Date"</span>, y <span class="op">=</span> <span class="st">"Reported COVID-19 counts"</span><span class="op">)</span></span></code></pre></div>
<p><img src="outliers_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>More advanced correction functionality will be coming at some point in the future.</p>
</div>
<div class="section level2">
<h2 id="attribution">Attribution<a class="anchor" aria-label="anchor" href="#attribution"></a>
</h2>
<p>This document contains dataset that is a modified part of the <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 Data Repository by the Center for Systems Science and Engineering (CSSE) at Johns Hopkins University</a> as <a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">republished in the COVIDcast Epidata API</a>. This data set is licensed under the terms of the <a href="https://creativecommons.org/licenses/by/4.0/" class="external-link">Creative Commons Attribution 4.0 International license</a> by the Johns Hopkins University on behalf of its Center for Systems Science in Engineering. Copyright Johns Hopkins University 2020.</p>
<p><a href="https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/jhu-csse.html" class="external-link">From the COVIDcast Epidata API</a>: These signals are taken directly from the JHU CSSE <a href="https://github.com/CSSEGISandData/COVID-19" class="external-link">COVID-19 GitHub repository</a> without changes.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Logan Brooks, Daniel McDonald, Evan Ray, Ryan Tibshirani.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
